
// Google Apps Script (Code.gs)

// ユーザーから提供されたスプレッドシートのIDを設定します
const SPREADSHEET_ID = "162_ZDhT9TwLGYKY28wVomEYtwu1tH6g46ff2cDNakAU";

/**
 * WebアプリのURLに直接アクセス（GETリクエスト）された場合に呼ばれる関数
 * @param {object} e - GETリクエストのイベントオブジェクト
 * @returns {HtmlService.HtmlOutput} - ブラウザに表示するHTML
 */
function doGet(e) {
  return HtmlService.createHtmlOutput("<h1>SNS連携大腸がんアンケート GAS</h1><p>Web App is active. This endpoint is for POST requests only.</p>");
}

/**
 * WebアプリからのPOSTリクエストを処理する関数
 * @param {object} e - POSTリクエストのイベントオブジェクト
 * @returns {ContentService.TextOutput} - 処理結果をJSON形式で返す
 */
function doPost(e) {
  // ★ 変更点: より詳細なログを出力するように修正
  console.log("doPost関数が開始されました。");

  try {
    // ★↓ MailApp.getRemainingDailyQuota(); の行をここから削除しました ★
    
    if (!e || !e.postData || !e.postData.contents) {
      console.error("無効なリクエストです: e.postData.contents が存在しません。");
      throw new Error("無効なリクエストです。このスクリプトはウェブアプリからのPOSTリクエストによって呼び出される必要があります。");
    }
    
    console.log("受け取った生データ:", e.postData.contents);
    const data = JSON.parse(e.postData.contents);
    console.log("JSONパース後のデータ:", JSON.stringify(data));
    
    if (!data || !data.userId) {
      console.error("必須データがありません: userIdが見つかりません。");
      throw new Error("必須データ（userId）がペイロードに含まれていません。");
    }
    console.log("userIdの確認ができました:", data.userId);

    const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
    console.log("スプレッドシートを開きました。");
    const sheet = spreadsheet.getSheetByName("回答データ") || spreadsheet.insertSheet("回答データ");
    console.log("シートを取得しました: ", sheet.getName());

    // ★ 変更点: クイズの正誤ヘッダーをより具体的に修正
    if (sheet.getLastRow() === 0) {
      const headers = [
        "タイムスタンプ", "LINE User ID", "クイズスコア", 
        "A-1_年代", "A-2_性別", "A-3_自治体検診", "A-4_精密検査", "A-5_家族歴",
        "B-1-1_受診意向", "B-2-1_リスク認識", "B-3-1_障壁(負担感)", "B-4-1_自己効力感(準備)", "同意",
        // クイズの正誤ヘッダーを修正
        "Q1(自覚症状)_正誤", "Q2(便潜血)_正誤", "Q3(年齢)_正誤", "Q4(内視鏡)_正誤", 
        "Q5(ポリープ)_正誤", "Q6(遺伝)_正誤", "Q7(運動)_正誤", "Q8(定期検査)_正誤"
      ];
      sheet.appendRow(headers);
      console.log("ヘッダー行を書き込みました。");
    }

    const surveyData = data.surveyData || {};
    
    // ★ 変更点: 同意の値を「はい」「いいえ」に簡略化
    const consentValue = surveyData["consent"] || "";
    let simpleConsent = "";
    if (consentValue === "はい（同意する）") {
      simpleConsent = "はい";
    } else if (consentValue === "いいえ（同意しない）") {
      simpleConsent = "いいえ";
    }
    console.log("同意の値を変換しました:", consentValue, "->", simpleConsent);
    
    // ★ 変更点: クイズの正誤データを「正解」「不正解」の文字列で抽出
    const quizResults = data.quizResults || [];
    const quizCorrectness = [];
    for (let i = 0; i < 8; i++) { // 8問あると仮定
      if (quizResults[i]) {
        quizCorrectness.push(quizResults[i].isCorrect ? "正解" : "不正解"); // "正解" または "不正解"
      } else {
        quizCorrectness.push(""); // データがない場合は空文字
      }
    }
    console.log("クイズの正誤データを抽出しました:", JSON.stringify(quizCorrectness));

    // ★ 変更点: newRow にクイズの正誤と簡略化した同意の値を追加
    const newRow = [
      new Date(), data.userId, data.quizScore,
      surveyData["A-1_age"] || "", surveyData["A-2_gender"] || "", surveyData["A-3_local_exam"] || "",
      surveyData["A-4_scope_exam"] || "", surveyData["A-5_family_history"] || "",
      surveyData["B-1-1_intention"] || "", surveyData["B-2-1_risk"] || "",
      surveyData["B-3-1_barrier_burden"] || "", surveyData["B-4-1_self_efficacy_prep"] || "",
      simpleConsent, // 簡略化した同意の値
      // クイズの正誤データを展開して追加
      ...quizCorrectness
    ];
    console.log("書き込む行データを作成しました:", JSON.stringify(newRow));

    sheet.appendRow(newRow);
    console.log("シートへの書き込みが完了しました。");

    return ContentService.createTextOutput(
      JSON.stringify({ result: "success", message: "データを正常に保存しました。" })
    ).setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    console.error("GAS Error:", error.toString(), "\nStack:", error.stack);
    return ContentService.createTextOutput(
      JSON.stringify({ result: "error", message: error.toString() })
    ).setMimeType(ContentService.MimeType.JSON);
  }
}
