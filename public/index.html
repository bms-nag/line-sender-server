<!DOCTYPE html>
<html lang="ja">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
Â  Â  <title>SNSé€£æºå¤§è…¸ãŒã‚“ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœ</title>
Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
Â  Â  <!-- LIFF SDK ã‚’èª­ã¿è¾¼ã¿ã¾ã™ -->
Â  Â  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
Â  Â  <link rel="preconnect" href="https://fonts.googleapis.com">
Â  Â  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
Â  Â  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@500;700;800&display=swap" rel="stylesheet">
Â  Â  <style>
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: 'M PLUS Rounded 1c', sans-serif;
Â  Â  Â  Â  Â  Â  background: #EFF6FF;
Â  Â  Â  Â  Â  Â  -webkit-user-select: none;Â 
Â  Â  Â  Â  Â  Â  user-select: none;
Â  Â  Â  Â  Â  Â  overflow-y: auto;
Â  Â  Â  Â  }
Â  Â  Â  Â  .game-board {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  max-width: 500px;
Â  Â  Â  Â  Â  Â  margin: 0 auto;
Â  Â  Â  Â  Â  Â  padding: 1rem;
Â  Â  Â  Â  }
Â  Â  Â  Â  .progress-bar-container {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  background-color: #E0E7FF;
Â  Â  Â  Â  Â  Â  border-radius: 9999px;
Â  Â  Â  Â  Â  Â  height: 20px;
Â  Â  Â  Â  Â  Â  border: 3px solid #C7D2FE;
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  }
Â  Â  Â  Â  #progress-bar {
Â  Â  Â  Â  Â  Â  background: linear-gradient(90deg, #A5B4FC, #818CF8);
Â  Â  Â  Â  Â  Â  width: 0%;
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  border-radius: 9999px;
Â  Â  Â  Â  Â  Â  transition: width 0.5s ease-out;
Â  Â  Â  Â  }
Â  Â  Â  Â  #pupu-progress-icon {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: 50%;
Â  Â  Â  Â  Â  Â  left: 0%;
Â  Â  Â  Â  Â  Â  transform: translate(-50%, -50%);
Â  Â  Â  Â  Â  Â  width: 48px;
Â  Â  Â  Â  Â  Â  height: 48px;
Â  Â  Â  Â  Â  Â  transition: left 0.5s ease-out;
Â  Â  Â  Â  }
Â  Â  Â  Â  .quiz-card {
Â  Â  Â  Â  Â  Â  background: white;
Â  Â  Â  Â  Â  Â  border-radius: 1.5rem;
Â  Â  Â  Â  Â  Â  padding: 1.5rem;
Â  Â  Â  Â  Â  Â  box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1);
Â  Â  Â  Â  Â  Â  transition: opacity 0.3s ease-out, transform 0.3s ease-out;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-choice {
Â  Â  Â  Â  Â  Â  border-radius: 9999px; font-weight: 800; font-size: 1.5rem; padding: 0.75rem 0;
Â  Â  Â  Â  Â  Â  cursor: pointer; transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
Â  Â  Â  Â  Â  Â  box-shadow: 0 6px 0 0; border: 3px solid white;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-choice:active { transform: translateY(4px); box-shadow: 0 2px 0 0; }
Â  Â  Â  Â  .btn-o { background-color: #fb7185; color: white; box-shadow-color: #e11d48; }
Â  Â  Â  Â  .btn-x { background-color: #38bdf8; color: white; box-shadow-color: #0284c7; }

Â  Â  Â  Â  .modal-overlay {
Â  Â  Â  Â  Â  Â  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
Â  Â  Â  Â  Â  Â  background: rgba(0,0,0,0.5); backdrop-filter: blur(8px);
Â  Â  Â  Â  Â  Â  display: flex; align-items: center; justify-content: center;
Â  Â  Â  Â  Â  Â  z-index: 50; opacity: 0; pointer-events: none; transition: opacity 0.3s ease-out;
Â  Â  Â  Â  Â  Â  padding: 1rem;
Â  Â  Â  Â  }
Â  Â  Â  Â  .modal-overlay.visible { opacity: 1; pointer-events: auto; }
Â  Â  Â  Â  .modal-content {
Â  Â  Â  Â  Â  Â  background: transparent;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  max-width: 500px;
Â  Â  Â  Â  Â  Â  transform: scale(0.95); transition: transform 0.3s ease-out;
Â  Â  Â  Â  }
Â  Â  Â  Â  .modal-overlay.visible .modal-content { transform: scale(1); }

Â  Â  Â  Â  .action-button {
Â  Â  Â  Â  Â  Â  background: linear-gradient(180deg, #F9A8D4, #F472B6);
Â  Â  Â  Â  Â  Â  color: white; border-radius: 9999px; padding: 0.75rem 2rem;
Â  Â  Â  Â  Â  Â  font-weight: 800; font-size: 1.125rem; box-shadow: 0 5px 0 #DB2777;
Â  Â  Â  Â  Â  Â  border: 2px solid white; cursor: pointer; transition: all 0.1s ease-out;
Â  Â  Â  Â  }
Â  Â  Â  Â  .action-button:active { transform: translateY(3px); box-shadow: 0 2px 0 #DB2777; }
Â  Â  Â  Â  
Â  Â  Â  Â  /* --- Survey Styles --- */
Â  Â  Â  Â  .survey-container-wrapper { width: 100%; position: relative; }
Â  Â  Â  Â  #pupu-guide-container { position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); z-index: 10; transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
Â  Â  Â  Â  #pupu-guide { width: 120px; height: auto; animation: pupu-breathing 3s infinite ease-in-out; }
Â  Â  Â  Â  .survey-shell { min-height: 500px; display: flex; flex-direction: column; background: white; border-radius: 1.5rem; padding: 1.5rem; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05), 0 20px 20px -10px rgba(99, 102, 241, 0.2); border: 1px solid #e0e7ff; }
Â  Â  Â  Â  .survey-content-area { position: relative; flex-grow: 1; display: flex; flex-direction: column; }
Â  Â  Â  Â  .survey-screen-content { display: flex; flex-direction: column; flex-grow: 1; }
Â  Â  Â  Â  .survey-progress-bar-container { width: 100%; background-color: #e5e7eb; border-radius: 9999px; height: 12px; overflow: hidden; border: 2px solid #e0e7ff;}
Â  Â  Â  Â  .survey-progress-bar { background: linear-gradient(to right, #818cf8, #a78bfa); height: 100%; border-radius: 9999px; transition: width 0.4s ease-out; }
Â  Â  Â  Â  .survey-option-label { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.5rem; padding: 1rem 0.5rem; border-radius: 1rem; background-color: #f3f4f6; cursor: pointer; transition: all 0.2s ease-out; font-size: 1rem; font-weight: 700; border: 2px solid transparent; min-height: 80px; }
Â  Â  Â  Â  .survey-option-label .icon { font-size: 2rem; line-height: 1; }
Â  Â  Â  Â  .survey-option-label:hover { background-color: #e5e7eb; transform: scale(1.02); }
Â  Â  Â  Â  .survey-option-input:checked + .survey-option-label { background-color: #e0e7ff; color: #4338ca; border-color: #6366f1; animation: pop-select 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
Â  Â  Â  Â  .likert-horizontal-container { width: 100%; margin: 2rem 0; }
Â  Â  Â  Â  .likert-emoji-bar { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background-color: #f3f4f6; border-radius: 9999px; }
Â  Â  Â  Â  .likert-emoji-label { font-size: 2.5rem; cursor: pointer; transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); filter: grayscale(80%); opacity: 0.6; }
Â  Â  Â  Â  .likert-emoji-input:checked + .likert-emoji-label { transform: scale(1.4); filter: grayscale(0%); opacity: 1; }
Â  Â  Â  Â  .likert-annotation-bar { display: flex; justify-content: space-between; padding: 0 0.5rem; margin-top: 0.5rem; font-size: 0.75rem; font-weight: 700; color: #6b7280; }
Â  Â  Â  Â  .survey-nav-button { background: linear-gradient(180deg, #818cf8, #6366f1); color: white; font-weight: 800; padding: 1rem; border-radius: 9999px; box-shadow: 0 5px 0 #4f46e5; transition: all 0.15s ease-out; font-size: 1.1rem; }
Â  Â  Â  Â  .survey-nav-button:active { transform: translateY(3px); box-shadow: 0 2px 0 #4f46e5; }
Â  Â  Â  Â  .survey-back-button { background: linear-gradient(180deg, #d1d5db, #9ca3af); box-shadow: 0 5px 0 #6b7280; }
Â  Â  Â  Â  .survey-back-button:active { transform: translateY(3px); box-shadow: 0 2px 0 #6b7280; }
Â  Â  Â  Â  
Â  Â  Â  Â  .survey-option-decline {
Â  Â  Â  Â  Â  Â  background-color: #f9fafb;
Â  Â  Â  Â  Â  Â  color: #9ca3af;
Â  Â  Â  Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  Â  Â  Â  border: 2px solid #f3f4f6;
Â  Â  Â  Â  }
Â  Â  Â  Â  .survey-option-decline:hover {
Â  Â  Â  Â  Â  Â  background-color: #f3f4f6;
Â  Â  Â  Â  }
Â  Â  Â  Â  .survey-option-input:checked + .survey-option-decline {
Â  Â  Â  Â  Â  Â  background-color: #e5e7eb;
Â  Â  Â  Â  Â  Â  color: #6b7280;
Â  Â  Â  Â  Â  Â  border-color: #d1d5db;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- Animations --- */
Â  Â  Â  Â  @keyframes content-fade-out { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-10px); } }
Â  Â  Â  Â  @keyframes content-fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
Â  Â  Â  Â  .content-out { animation: content-fade-out 0.3s ease-out forwards; }
Â  Â  Â  Â  .content-in { animation: content-fade-in 0.4s ease-out forwards; }
Â  Â  Â  Â  @keyframes pop-select { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
Â  Â  Â  Â  @keyframes pupu-breathing { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
Â  Â  Â  Â  @keyframes blinking-next { 0% { transform: scale(1); box-shadow: 0 5px 0 var(--shadow-color), 0 0 0 0 rgba(34, 197, 94, 0.7); } 70% { transform: scale(1.05); box-shadow: 0 5px 0 var(--shadow-color), 0 0 0 15px rgba(34, 197, 94, 0); } 100% { transform: scale(1); box-shadow: 0 5px 0 var(--shadow-color), 0 0 0 0 rgba(34, 197, 94, 0); } }
Â  Â  Â  Â  .blinking-next-button { animation: blinking-next 1.5s infinite; }
Â  Â  </style>
</head>
<body>
Â  Â  <div class="game-board">
Â  Â  Â  Â  <header class="text-center my-4"><h1 class="text-2xl font-extrabold text-slate-700">SNSé€£æºå¤§è…¸ãŒã‚“ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœ</h1></header>
Â  Â  Â  Â  <div class="progress-bar-container mb-4">
Â  Â  Â  Â  Â  Â  <div id="progress-bar"></div>
Â  Â  Â  Â  Â  Â  <img id="pupu-progress-icon" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3Cfilter id='dropShadow' x='-20%25' y='-20%25' width='140%25' height='140%25'%3E%3CfeDropShadow dx='2' dy='4' stdDeviation='2' flood-color='%23000000' flood-opacity='0.2'/%3E%3C/filter%3E%3CradialGradient id='poopGradient' cx='0.5' cy='1' r='1'%3E%3Cstop offset='0%25' stop-color='%23A1887F'/%3E%3Cstop offset='100%25' stop-color='%235D4037'/%3E%3C/radialGradient%3E%3C/defs%3E%3Cg filter='url(%23dropShadow)'%3E%3Cpath d='M50 95 C 20 95, 20 65, 50 65 C 80 65, 80 95, 50 95 Z' fill='url(%23poopGradient)'/%3E%3Cpath d='M50 70 C 28 70, 28 45, 50 45 C 72 45, 72 70, 50 70 Z' fill='url(%23poopGradient)'/%3E%3Cpath d='M50 50 C 38 50, 38 30, 50 30 C 62 30, 62 50, 50 50 Z' fill='url(%23poopGradient)'/%3E%3Ccircle cx='38' cy='68' r='7' fill='white'/%3E%3Ccircle cx='62' cy='68' r='7' fill='white'/%3E%3Ccircle cx='39' cy='69' r='4' fill='black'/%3E%3Ccircle cx='61' cy='69' r='4' fill='black'/%3E%3Cpath d='M45 82 Q 50 88 55 82' stroke='white' stroke-width='3' fill='none' stroke-linecap='round'/%3E%3C/g%3E%3C/svg%3E" alt="ã·ã·ã‚¢ã‚¤ã‚³ãƒ³">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="card-container" class="relative" style="min-height: 450px;"></div>
Â  Â  </div>
Â  Â  <div id="modal-container"></div>
Â  Â  
Â  Â  <script>
Â  Â  Â  Â  // --- CONFIGURATION ---
Â  Â  Â  Â  const LIFF_ID = "2007757059-nepa16EO";
Â  Â  Â  Â  const LINE_ACCOUNT_URL = "https://lin.ee/NmU3RyA";
Â  Â  Â  Â  const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxl_0SlDxKRF_4QmAEUQnnoykDKxECCqgbmhAzglSHOHJlEEBs4M2mRneQ60COzn5ns/exec";

Â  Â  Â  Â  const quizData = [
Â  Â  Â  Â  Â  Â  { question: "å¤§è…¸ãŒã‚“ã®åˆæœŸã«ã¯ã€å¿…ãšãŠè…¹ã®ç—›ã¿ã‚„è¡€ä¾¿ãªã©ã®è‡ªè¦šç—‡çŠ¶ãŒã‚ã‚‹ã€‚", correctAnswer: "Ã—", explanation: "åˆæœŸã¯ç—‡çŠ¶ãŒãªã„ã“ã¨ãŒå¤šã„ã‚“ã ã€‚ã ã‹ã‚‰æ¤œè¨ºãŒå¤§äº‹ï¼", illustration: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='55' font-size='50' text-anchor='middle' dominant-baseline='middle'%3EğŸ¤«%3C/text%3E%3C/svg%3E`, explanationIllustration: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='55' font-size='50' text-anchor='middle'%3EğŸ‘»%3C/text%3E%3C/svg%3E`},
Â  Â  Â  Â  Â  Â  { question: "ä¾¿æ½œè¡€æ¤œæŸ»ã§ã€Œç•°å¸¸ãªã—ã€ãªã‚‰ã€ã‚‚ã†å¤§è…¸ãŒã‚“ã®å¿ƒé…ã¯ã‚¼ãƒ­ã ï¼", correctAnswer: "Ã—", explanation: "ä¾¿æ½œè¡€æ¤œæŸ»ã ã‘ã˜ã‚ƒè¦‹é€ƒã™ã“ã¨ã‚‚ã€‚æ°—ã«ãªã‚‹ãªã‚‰ç²¾å¯†æ¤œæŸ»ã‚‚è€ƒãˆã‚ˆã†ï¼", illustration: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='55' font-size='50' text-anchor='middle' dominant-baseline='middle'%3EğŸ§ª%3C/text%3E%3C/svg%3E`, explanationIllustration: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='55' font-size='50' text-anchor='middle'%3EğŸ”¬%3C/text%3E%3C/svg%3E`},
Â  Â  Â  Â  Â  Â  { question: "å¤§è…¸ãŒã‚“ã¯ã€ãŠã˜ã„ã¡ã‚ƒã‚“ãŠã°ã‚ã¡ã‚ƒã‚“ã®ç—…æ°—ã€‚è‹¥ã„äººã¯é–¢ä¿‚ãªã„ï¼", correctAnswer: "Ã—", explanation: "ãã‚“ãªã“ã¨ãªã„ï¼æœ€è¿‘ã¯è‹¥ã„äººã§ã‚‚å¢—ãˆã¦ã‚‹ã‹ã‚‰æ²¹æ–­ã¯ç¦ç‰©ã ã‚ˆã€‚", illustration: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='55' font-size='50' text-anchor='middle' dominant-baseline='middle'%3EğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦%3C/text%3E%3C/svg%3E`, explanationIllustration: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='55' font-size='50' text-anchor='middle'%3EğŸ§‘%3C/text%3E%3C/svg%3E`},
Â  Â  Â  Â  Â  Â  { question: "å¤§è…¸ã‚«ãƒ¡ãƒ©ï¼ˆå†…è¦–é¡ï¼‰ã£ã¦ã€ã‚‚ã®ã™ã”ãƒ¼ãç—›ãã¦å¤§å¤‰ãªæ¤œæŸ»ã ï¼", correctAnswer: "Ã—", explanation: "ä»Šã¯éº»é…”ã§æ¥½ã«å—ã‘ã‚‰ã‚Œã‚‹ç—…é™¢ãŒå¤šã„ã‚“ã ã€‚CTæ¤œæŸ»ã‚‚ã‚ã‚‹ã‚ˆï¼", illustration: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='55' font-size='50' text-anchor='middle' dominant-baseline='middle'%3EğŸ˜´%3C/text%3E%3C/svg%3E`, explanationIllustration: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='55' font-size='50' text-anchor='middle'%3EğŸ˜Œ%3C/text%3E%3C/svg%3E`},
Â  Â  Â  Â  Â  Â  { question: "ãƒãƒªãƒ¼ãƒ—ãŒè¦‹ã¤ã‹ã£ã¦ã‚‚ã€å…¨éƒ¨ãŒãŒã‚“ã«ãªã‚‹ã‚ã‘ã˜ã‚ƒãªã„ã‹ã‚‰ã€æ”¾ã£ã¦ãŠã„ã¦ã‚‚å¹³æ°—ï¼", correctAnswer: "Ã—", explanation: "ãŒã‚“ã«ãªã‚‹ãƒãƒªãƒ¼ãƒ—ã‚‚ã‚ã‚‹ã‹ã‚‰ã€ãŠåŒ»è€…ã•ã‚“ã®æŒ‡ç¤ºã«å¾“ã£ã¦ã­ã€‚", illustration: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='55' font-size='50' text-anchor='middle' dominant-baseline='middle'%3Eâš ï¸%3C/text%3E%3C/svg%3E`, explanationIllustration: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='55' font-size='50' text-anchor='middle'%3EğŸ‘¨â€âš•ï¸%3C/text%3E%3C/svg%3E`},
Â  Â  Â  Â  Â  Â  { question: "å®¶æ—ã«ãŒã‚“ã®äººãŒã„ãªãã‚ƒã€è‡ªåˆ†ã¯éºä¼çš„ã«å®‰å¿ƒã ï¼", correctAnswer: "Ã—", explanation: "éºä¼ã ã‘ã˜ã‚ƒãªã„ï¼é£Ÿç”Ÿæ´»ã‚„é‹å‹•ä¸è¶³ã‚‚å¤§ããªåŸå› ã«ãªã‚‹ã‚“ã ã€‚", illustration: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='55' font-size='50' text-anchor='middle' dominant-baseline='middle'%3EğŸ§¬%3C/text%3E%3C/svg%3E`, explanationIllustration: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='55' font-size='50' text-anchor='middle' dominant-baseline='middle'%3EğŸ”%3C/text%3E%3C/svg%3E`},
Â  Â  Â  Â  Â  Â  { question: "é‹å‹•ã¯ã€å¤§è…¸ãŒã‚“ã®äºˆé˜²ã«åŠ¹æœãŒã‚ã‚‹ã€‚", correctAnswer: "â—‹", explanation: "å®šæœŸçš„ãªé‹å‹•ã¯ã€ãŒã‚“ã®ãƒªã‚¹ã‚¯ã‚’ä¸‹ã’ã‚‹ã“ã¨ãŒçŸ¥ã‚‰ã‚Œã¦ã„ã‚‹ã‚ˆã€‚æ—¥ã€…ã®ç”Ÿæ´»ã«é‹å‹•ã‚’å–ã‚Šå…¥ã‚Œã‚ˆã†ï¼", illustration: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='55' font-size='50' text-anchor='middle' dominant-baseline='middle'%3EğŸƒâ€â™‚ï¸%3C/text%3E%3C/svg%3E`, explanationIllustration: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='55' font-size='50' text-anchor='middle'%3EğŸ’ª%3C/text%3E%3C/svg%3E`},
Â  Â  Â  Â  Â  Â  { question: "ä¸€å›æ¤œæŸ»ã—ã¦OKã ã£ãŸã‚‰ã€ã‚‚ã†ä¸€ç”Ÿæ¤œæŸ»ã—ãªãã¦ã„ã„ï¼", correctAnswer: "Ã—", explanation: "ä½“ã¯å¤‰åŒ–ã™ã‚‹ã‹ã‚‰ã€å®šæœŸçš„ãªãƒã‚§ãƒƒã‚¯ãŒå¤§åˆ‡ãªã‚“ã ã‚ˆã€‚", illustration: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='55' font-size='50' text-anchor='middle' dominant-baseline='middle'%3EğŸ—“ï¸%3C/text%3E%3C/svg%3E`, explanationIllustration: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='55' font-size='50' text-anchor='middle'%3EğŸ”„%3C/text%3E%3C/svg%3E`}
Â  Â  Â  Â  ];
Â  Â  Â  Â  const surveyData = [
Â  Â  Â  Â  Â  Â  { screen: 1, type: 'radio', id: 'A-1_age', question: 'ã‚ãªãŸã®å¹´ä»£ã‚’æ•™ãˆã¦ï¼', options: [{t:'20ä»£ä»¥ä¸‹'}, {t:'30ä»£'}, {t:'40ä»£'}, {t:'50ä»£'}, {t:'60ä»£'}, {t:'70ä»£ä»¥ä¸Š'}], layout: 'grid-cols-3' },
Â  Â  Â  Â  Â  Â  { screen: 2, type: 'radio', id: 'A-2_gender', question: 'ã‚ãªãŸã®æ€§åˆ¥ã¯ã©ã£ã¡ã‹ãªï¼Ÿ', options: [{t:'ç”·æ€§',i:'â™‚ï¸'}, {t:'å¥³æ€§',i:'â™€ï¸'}, {t:'ãã®ä»–',i:'ğŸŒˆ'}, {t:'å›ç­”ã—ãªã„',i:'ğŸ¤«'}], layout: 'grid-cols-2' },
Â  Â  Â  Â  Â  Â  { screen: 3, type: 'radio', id: 'A-3_local_exam', question: 'è‡ªæ²»ä½“ã‚„è·å ´ã®æ¤œè¨ºï¼ˆä¾¿æ½œè¡€æ¤œæŸ»ï¼‰ã€å—ã‘ãŸã“ã¨ã‚ã‚‹ï¼Ÿ', options: [{t:'ã‚ã‚‹',i:'ğŸ‘'}, {t:'ãªã„',i:'âŒ'}, {t:'ã‚ã‹ã‚‰ãªã„',i:'ğŸ¤”'}], layout: 'grid-cols-3' },
Â  Â  Â  Â  Â  Â  { screen: 4, type: 'radio', id: 'A-4_scope_exam', question: 'ç—…é™¢ã§è©³ã—ã„æ¤œæŸ»ï¼ˆå¤§è…¸ã‚«ãƒ¡ãƒ©ãƒ»å¤§è…¸CTï¼‰ã‚’ã—ãŸã“ã¨ã‚ã‚Šã¾ã™ã‹ï¼Ÿ', options: [{t:'ã‚ã‚‹',i:'ğŸ‘'}, {t:'ãªã„',i:'âŒ'}, {t:'ã‚ã‹ã‚‰ãªã„',i:'ğŸ¤”'}], layout: 'grid-cols-3' },
Â  Â  Â  Â  Â  Â  { screen: 5, type: 'radio', id: 'A-5_family_history', question: 'è¡€ã®ã¤ãªãŒã£ãŸå®¶æ—ã«å¤§è…¸ãŒã‚“ã®äººã€ã„ã‚‹ï¼Ÿ', options: [{t:'ã„ã‚‹',i:'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦'}, {t:'ã„ãªã„',i:'âŒ'}, {t:'ã‚ã‹ã‚‰ãªã„',i:'ğŸ¤”'}], layout: 'grid-cols-3' },
Â  Â  Â  Â  Â  Â  { screen: 6, type: 'section_header', title: 'å¾ŒåŠæˆ¦ï¼' },
Â  Â  Â  Â  Â  Â  { screen: 7, type: 'likert', id: 'B-1-1_intention', question: '1å¹´ä»¥å†…ã«å¤§è…¸ãŒã‚“æ¤œè¨ºã€å—ã‘ã¦ã¿ãŸã„ï¼Ÿ', options: [{ v: 1, l: 'å…¨ãå—ã‘ãŸããªã„' }, { v: 2, l: 'ã‚ã¾ã‚Šå—ã‘ãŸããªã„' }, { v: 3, l: 'ã©ã¡ã‚‰ã¨ã‚‚ã„ãˆãªã„' }, { v: 4, l: 'ã§ãã‚Œã°å—ã‘ãŸã„' }, { v: 5, l: 'ãœã²å—ã‘ãŸã„' }] },
Â  Â  Â  Â  Â  Â  { screen: 8, type: 'likert', id: 'B-2-1_risk', question: 'å°†æ¥ã€è‡ªåˆ†ãŒå¤§è…¸ãŒã‚“ã«ãªã‚‹å¯èƒ½æ€§ã€ã©ã†æ€ã†ï¼Ÿ', options: [{ v: 1, l: 'é«˜ã„ã¨æ€ã†' }, { v: 2, l: 'ã‚„ã‚„é«˜ã„ã¨æ€ã†' }, { v: 3, l: 'ä»–ã®äººã¨åŒã˜ãã‚‰ã„' }, { v: 4, l: 'ã‚ã¾ã‚Šé«˜ããªã„' }, { v: 5, l: 'ã»ã¨ã‚“ã©ãªã„' }] },
Â  Â  Â  Â  Â  Â  { screen: 9, type: 'likert', id: 'B-3-1_barrier_burden', question: 'è©³ã—ã„æ¤œæŸ»ï¼ˆå¤§è…¸ã‚«ãƒ¡ãƒ©ãƒ»å¤§è…¸CTï¼‰ã£ã¦ã€ç—›ã‹ã£ãŸã‚Šå¤§å¤‰ãã†ï¼Ÿ', options: [{ v: 1, l: 'éå¸¸ã«ãã†æ€ã†' }, { v: 2, l: 'ã‚„ã‚„ãã†æ€ã†' }, { v: 3, l: 'ã©ã¡ã‚‰ã¨ã‚‚ã„ãˆãªã„' }, { v: 4, l: 'ã‚ã¾ã‚Šæ€ã‚ãªã„' }, { v: 5, l: 'å…¨ãæ€ã‚ãªã„' }] },
Â  Â  Â  Â  Â  Â  { screen: 10, type: 'likert', id: 'B-4-1_self_efficacy_prep', question: 'ã‚‚ã—ãŠåŒ»è€…ã•ã‚“ã«å‹§ã‚ã‚‰ã‚ŒãŸã‚‰ã€æ¤œæŸ»ã®æº–å‚™ã€ã¡ã‚ƒã‚“ã¨ã§ããã†ï¼Ÿ', options: [{ v: 1, l: 'å…¨ãè‡ªä¿¡ãŒãªã„' }, { v: 2, l: 'ã‚ã¾ã‚Šè‡ªä¿¡ãŒãªã„' }, { v: 3, l: 'ã©ã¡ã‚‰ã¨ã‚‚ã„ãˆãªã„' }, { v: 4, l: 'ãŸã¶ã‚“ã§ãã‚‹' }, { v: 5, l: 'çµ¶å¯¾ã«ã§ãã‚‹' }] },
Â  Â  Â  Â  Â  Â  { screen: 11, type: 'consent', id: 'consent', title: 'æœ€å¾Œã®ãŠé¡˜ã„ï¼', question: 'ã”å›ç­”ã„ãŸã ã„ãŸå†…å®¹ã¯ã€å€‹äººãŒç‰¹å®šã•ã‚Œãªã„çµ±è¨ˆæƒ…å ±ã¨ã—ã¦ã€ä»Šå¾Œã®ç ”ç©¶æ´»å‹•ã‚„ã‚µãƒ¼ãƒ“ã‚¹æ”¹å–„ï¼ˆå•†æ¥­åˆ©ç”¨ã‚’å«ã‚€ï¼‰ã®ãŸã‚ã«æ´»ç”¨ã•ã›ã¦ã„ãŸã ãå ´åˆãŒã”ã–ã„ã¾ã™ã€‚<br><br>ã“ã®ç‚¹ã«ã¤ã„ã¦ã€ã”åŒæ„ã„ãŸã ã‘ã¾ã™ã§ã—ã‚‡ã†ã‹ï¼Ÿ', options: [{t:'ã¯ã„ï¼ˆåŒæ„ã™ã‚‹ï¼‰',i:'ğŸ¤'}, {t:'ã„ã„ãˆï¼ˆåŒæ„ã—ãªã„ï¼‰', style: 'decline'}], layout: 'grid-cols-2' },
Â  Â  Â  Â  Â  Â  { screen: 12, type: 'completion', title: 'ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå®Œäº†ï¼<br>å”åŠ›ã‚ã‚ŠãŒã¨ã†ï¼', buttonText: 'å›ç­”ã‚’é€ä¿¡ã—ã¦çµæœã«æˆ»ã‚‹' }
Â  Â  Â  Â  ];
Â  Â  Â  Â  const totalScreens = surveyData.filter(s => s.type !== 'completion' && s.type !== 'section_header').length;

Â  Â  Â  Â  // --- ELEMENTS & STATE ---
Â  Â  Â  Â  const cardContainer = document.getElementById('card-container');
Â  Â  Â  Â  const modalContainer = document.getElementById('modal-container');
Â  Â  Â  Â  const progressBar = document.getElementById('progress-bar');
Â  Â  Â  Â  const pupuIcon = document.getElementById('pupu-progress-icon');
Â  Â  Â  Â  let currentQIndex = 0;
Â  Â  Â  Â  let currentScore = 0;
Â  Â  Â  Â  let userSelections = {};
Â  Â  Â  Â  let surveyAnswers = {};
Â  Â  Â  Â  let currentSurveyScreen = 0;

Â  Â  Â  Â  // --- SOUNDS ---
Â  Â  Â  Â  const correctSound = new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1}, volume: -10 }).toDestination();
Â  Â  Â  Â  const wrongSound = new Tone.Synth({ oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.2 }, volume: -15 }).toDestination();
Â  Â  Â  Â  const clickSound = new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 2, volume: -18 }).toDestination();
Â  Â  Â  Â  function playSound(type) {
Â  Â  Â  Â  Â  Â  if (Tone.context.state !== 'running') { Tone.context.resume(); }
Â  Â  Â  Â  Â  Â  if(type === 'correct') correctSound.triggerAttackRelease("G4", "16n");
Â  Â  Â  Â  Â  Â  else if(type === 'wrong') wrongSound.triggerAttackRelease("C3", "8n");
Â  Â  Â  Â  Â  Â  else clickSound.triggerAttackRelease("C4", "32n");
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // --- TEMPLATES & RENDERING ---
Â  Â  Â  Â  function renderCard(index) {
Â  Â  Â  Â  Â  Â  const q = quizData[index];
Â  Â  Â  Â  Â  Â  const cardHTML = `<div id="quiz-card-${index}" class="quiz-card absolute w-full h-full flex flex-col items-center justify-between"><div class="text-left w-full"><p class="text-sm font-bold text-indigo-500">ã‚‚ã‚“ã ã„ ${index + 1}</p><h2 class="text-xl font-extrabold text-slate-700 mt-2">${q.question}</h2></div><img src="${q.illustration}" class="w-28 h-28 my-4"><div class="grid grid-cols-2 gap-4 w-full"><button class="btn-choice btn-o" data-value="â—‹">â—‹</button><button class="btn-choice btn-x" data-value="Ã—">Ã—</button></div></div>`;
Â  Â  Â  Â  Â  Â  cardContainer.innerHTML = cardHTML;
Â  Â  Â  Â  Â  Â  attachCardListeners(index);
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderModal(content, addListeners = true) {
Â  Â  Â  Â  Â  Â  modalContainer.innerHTML = `<div class="modal-overlay"><div class="modal-content">${content}</div></div>`;
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  const overlay = modalContainer.querySelector('.modal-overlay');
Â  Â  Â  Â  Â  Â  Â  Â  if (overlay) overlay.classList.add('visible');
Â  Â  Â  Â  Â  Â  }, 10);
Â  Â  Â  Â  Â  Â  if(addListeners) attachModalListeners();
Â  Â  Â  Â  }

Â  Â  Â  Â  function closeModal() {
Â  Â  Â  Â  Â  Â  const overlay = modalContainer.querySelector('.modal-overlay');
Â  Â  Â  Â  Â  Â  if(overlay) {
Â  Â  Â  Â  Â  Â  Â  Â  overlay.classList.remove('visible');
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => { modalContainer.innerHTML = ''; }, 300);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateProgress() {
Â  Â  Â  Â  Â  Â  const progress = ((currentQIndex) / quizData.length) * 100;
Â  Â  Â  Â  Â  Â  progressBar.style.width = `${progress}%`;
Â  Â  Â  Â  Â  Â  pupuIcon.style.left = `${progress}%`;
Â  Â  Â  Â  }

Â  Â  Â  Â  const templates = {};

Â  Â  Â  Â  templates.linePrompt = `
Â  Â  Â  Â  Â  Â  <div style="background:white; border-radius:1.5rem; padding:2rem;">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-xl font-bold text-green-600 mb-2">è¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆã®å‰ã«ï¼</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-slate-600 font-bold mb-6 text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  çµæœã‚’è¦‹ã‚‹ã«ã¯ã€LINEã®ãŠå‹é”ç™»éŒ²ã‚’ãŠé¡˜ã„ã—ã¾ã™ï¼<br>å½¹ç«‹ã¤å¥åº·æƒ…å ±ã‚‚ãŠå±Šã‘ã—ã¾ã™ã€‚
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="line-register-button" class="action-button w-full" style="background: linear-gradient(180deg, #4ade80, #22c55e); box-shadow-color: #15803d;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  LINEç™»éŒ²ã—ã¦ã€çµæœã‚’è¦‹ã‚‹
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  - Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>`;

Â  Â  Â  Â  templates.lineThanks = `
Â  Â  Â  Â  Â  Â  <div style="background:white; border-radius:1.5rem; padding:2rem;">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-xl font-bold text-green-600 mb-2">ã‚ã‚ŠãŒã¨ã†ï¼</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-slate-600 font-bold mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ä¸‹ã®ãƒœã‚¿ãƒ³ã§çµæœã‚’ç¢ºèªã—ã¦ã­ã€‚
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="show-results-button" class="action-button w-full">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  çµæœã‚’è¦‹ã‚‹
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>`;

Â  Â  Â  Â  templates.results = (score, selections, showSurveyButton = true) => {
Â  Â  Â  Â  Â  Â  const percentage = Math.round((score / quizData.length) * 100);
Â  Â  Â  Â  Â  Â  let resultEmoji = percentage >= 80 ? 'ğŸ¥³' : (percentage < 40 ? 'ğŸ˜¥' : 'ğŸ¤”');
Â  Â  Â  Â  Â  Â  const resultsHTML = quizData.map((item, i) => {
Â  Â  Â  Â  Â  Â  Â  Â  const isCorrect = selections[i] === item.correctAnswer;
Â  Â  Â  Â  Â  Â  Â  Â  return `<div class="p-4 rounded-2xl ${isCorrect ? 'bg-green-50' : 'bg-red-50'} border-2 ${isCorrect ? 'border-green-200' : 'border-red-200'}"><p class="font-bold text-slate-700 text-sm text-left">${item.question}</p><div class="grid grid-cols-2 gap-3 text-center my-3"><div class="p-2 rounded-xl bg-white/80"><p class="text-slate-500 font-bold text-xs">ã‚ãªãŸã®ç­”ãˆ</p><p class="text-5xl font-extrabold ${isCorrect ? 'text-slate-700' : 'text-red-500'}">${selections[i]}</p></div><div class="p-2 rounded-xl bg-white/80"><p class="text-slate-500 font-bold text-xs">æ­£è§£ã¯...</p><p class="text-5xl font-extrabold text-amber-500">${item.correctAnswer}</p></div></div><div class="mt-2 text-left p-3 bg-white/50 rounded-xl flex items-center gap-3"><img src="${item.explanationIllustration}" class="w-12 h-12 flex-shrink-0"><p class="text-sm font-bold text-slate-600 flex-1">${item.explanation}</p></div></div>`;
Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const buttonHTML = showSurveyButtonÂ 
Â  Â  Â  Â  Â  Â  Â  Â  ? `<div class="mt-6 text-center"><button id="start-survey-button" class="action-button text-xl w-full max-w-xs mx-auto blinking-next-button" style="background: linear-gradient(180deg, #4ade80, #22c55e); --shadow-color: #15803d; padding: 1rem 2rem;">æ¬¡ã¸ï¼</button></div>`
Â  Â  Â  Â  Â  Â  Â  Â  : `<div class="mt-6 text-center"><button id="close-final-results-button" class="action-button text-xl w-full max-w-xs mx-auto" style="background: linear-gradient(180deg, #a78bfa, #8b5cf6); box-shadow-color: #6d28d9; padding: 1rem 2rem;">é–‰ã˜ã‚‹</button></div>`;

Â  Â  Â  Â  Â  Â  return `<div style="background:white; border-radius:1.5rem; padding:1rem;"><div class="w-full h-full flex flex-col p-2"><div class="text-center mb-2"><p class="text-6xl">${resultEmoji}</p><h2 class="text-lg font-bold text-slate-700">${percentage >= 80 ? 'ã™ã”ã„ï¼çŸ¥è­˜ã‚«ãƒ³ãƒšã‚­ï¼' : (percentage >= 40 ? 'ãŠã—ã„ï¼ã‚ã¨ã‚‚ã†ã¡ã‚‡ã£ã¨ï¼' : 'ã¾ã ã¾ã ã®ã³ã—ã‚ã‚ã‚Šï¼')}</h2><p class="text-4xl font-extrabold text-amber-500">${score}<span class="text-xl">/${quizData.length}å•æ­£è§£</span></p></div><div class="space-y-3 overflow-y-auto flex-grow max-h-[50vh] p-1">${resultsHTML}</div>${buttonHTML}</div></div>`;
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- EVENT LISTENERS ---
Â  Â  Â  Â  function attachCardListeners(index) {Â 
Â  Â  Â  Â  Â  Â  document.getElementById(`quiz-card-${index}`).querySelectorAll('.btn-choice').forEach(btn => btn.addEventListener('click', e => {
Â  Â  Â  Â  Â  Â  Â  Â  if (e.currentTarget.parentElement.parentElement.dataset.answered) return;
Â  Â  Â  Â  Â  Â  Â  Â  e.currentTarget.parentElement.parentElement.dataset.answered = 'true';
Â  Â  Â  Â  Â  Â  Â  Â  handleAnswer(index, e.target.dataset.value);
Â  Â  Â  Â  Â  Â  }));
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function attachModalListeners() {
Â  Â  Â  Â  Â  Â  const listeners = {
Â  Â  Â  Â  Â  Â  Â  Â  '#line-register-button': () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  playSound('click');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.open(LINE_ACCOUNT_URL, '_blank');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderModal(templates.lineThanks);
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  '#show-results-button': () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  playSound('click');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderModal(templates.results(currentScore, userSelections, true));
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  '#start-survey-button': () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  playSound('click');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startSurvey();
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  '#close-final-results-button': () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  playSound('click');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  closeModal();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  for (const selector in listeners) {
Â  Â  Â  Â  Â  Â  Â  Â  const el = document.querySelector(selector);
Â  Â  Â  Â  Â  Â  Â  Â  if (el) el.addEventListener('click', listeners[selector]);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // --- CORE LOGIC ---
Â  Â  Â  Â  function handleAnswer(index, value) {
Â  Â  Â  Â  Â  Â  userSelections[index] = value;
Â  Â  Â  Â  Â  Â  if (value === quizData[index].correctAnswer) { playSound('correct'); currentScore++; } else { playSound('wrong'); }
Â  Â  Â  Â  Â  Â  const card = document.getElementById(`quiz-card-${index}`);
Â  Â  Â  Â  Â  Â  card.style.opacity = '0';
Â  Â  Â  Â  Â  Â  card.style.transform = 'scale(0.9)';
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  currentQIndex++; updateProgress();
Â  Â  Â  Â  Â  Â  Â  Â  if (currentQIndex < quizData.length) { renderCard(currentQIndex); }Â 
Â  Â  Â  Â  Â  Â  Â  Â  else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cardContainer.innerHTML = `<div class="quiz-card flex items-center justify-center text-center"><h2 class="text-2xl font-extrabold text-slate-700">ãŠã¤ã‹ã‚Œã•ã¾ï¼<br>è¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã™ã‚‹ã‚ˆï¼</h2></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â renderModal(templates.linePrompt);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 800);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }, 300);
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * @function showFinalResultsPage
Â  Â  Â  Â  Â * @description ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆé€ä¿¡å¾Œã«ã€ç”»é¢å…¨ä½“ã‚’æœ€çµ‚çµæœè¡¨ç¤ºã«åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function showFinalResultsPage() {
Â  Â  Â  Â  Â  Â  // ä¸Šéƒ¨ã®ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’éè¡¨ç¤ºã«ã™ã‚‹
Â  Â  Â  Â  Â  Â  const mainProgressBar = document.querySelector('.progress-bar-container');
Â  Â  Â  Â  Â  Â  if (mainProgressBar) mainProgressBar.style.display = 'none';

Â  Â  Â  Â  Â  Â  // ãƒ¡ã‚¤ãƒ³ã®è¡¨ç¤ºé ˜åŸŸã‚’çµæœè¡¨ç¤ºã«æ›¸ãæ›ãˆã‚‹
Â  Â  Â  Â  Â  Â  cardContainer.innerHTML = templates.results(currentScore, userSelections, false);
Â  Â  Â  Â  Â  Â  cardContainer.classList.remove('relative');
Â  Â  Â  Â  Â  Â  cardContainer.style.minHeight = 'auto';

Â  Â  Â  Â  Â  Â  // æ–°ã—ãä½œã‚‰ã‚ŒãŸã€Œé–‰ã˜ã‚‹ã€ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ ã™ã‚‹
Â  Â  Â  Â  Â  Â  const closeButton = document.getElementById('close-final-results-button');
Â  Â  Â  Â  Â  Â  if (closeButton) {
Â  Â  Â  Â  Â  Â  Â  Â  closeButton.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  playSound('click');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã‚‰ã€æ„Ÿè¬ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cardContainer.innerHTML = `<div class="survey-shell flex items-center justify-center text-center" style="min-height: 500px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-extrabold text-slate-700">ã”å”åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼<br>ã“ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã¦ãã ã•ã„ã€‚</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // LINEã‚¢ãƒ—ãƒªå†…ã§é–‹ã‹ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã‚‹
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (liff && liff.isInClient()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => liff.closeWindow(), 2000);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * @function submitSurveyDataToGAS
Â  Â  Â  Â  Â * @description ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’GASã«é€ä¿¡ã™ã‚‹é–¢æ•°ã€‚æˆåŠŸæ™‚ãƒ»å¤±æ•—æ™‚ã®è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ã‚’ä¿®æ­£ã€‚
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function submitSurveyDataToGAS() {
Â  Â  Â  Â  Â  Â  renderModal(`
Â  Â  Â  Â  Â  Â  Â  Â  <div style="background:white; border-radius:1.5rem; padding:2rem; text-align:center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-xl font-bold text-indigo-600 mb-2">é€ä¿¡ä¸­...</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="save-status" class="text-slate-600 font-bold mb-4"></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-indigo-500 mx-auto"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `, false);

Â  Â  Â  Â  Â  Â  const statusElement = document.getElementById('save-status');

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  await liff.init({ liffId: LIFF_ID });

Â  Â  Â  Â  Â  Â  Â  Â  if (!liff.isLoggedIn()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const stateToSave = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentScore: currentScore,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userSelections: userSelections,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  surveyAnswers: surveyAnswers
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sessionStorage.setItem('appState', JSON.stringify(stateToSave));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sessionStorage.setItem('isLiffLoginRedirect', 'true');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  liff.login({ redirectUri: window.location.href });Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;Â 
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const profile = await liff.getProfile();
Â  Â  Â  Â  Â  Â  Â  Â  const userId = profile.userId;
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const quizResults = quizData.map((q, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const userAnswer = userSelections[index] || "æœªå›ç­”";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  question: q.question,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userAnswer: userAnswer,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  correctAnswer: q.correctAnswer,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isCorrect: userAnswer === q.correctAnswer
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  const payload = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userId: userId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  quizScore: currentScore,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  surveyData: surveyAnswers,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  quizResults: quizResults
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(GAS_WEB_APP_URL, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mode: 'no-cors', // Added for potential cross-origin issues with GAS redirects
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'Content-Type': 'text/plain;charset=utf-8',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify(payload)
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  // In 'no-cors' mode, we can't read the response. We optimistically assume success.
Â  Â  Â  Â  Â  Â  Â  Â  // A more robust solution would involve a different GAS deployment method (JSONP, etc.)
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // é€ä¿¡æˆåŠŸæ™‚: ãƒ¢ãƒ¼ãƒ€ãƒ«ã§ã¯ãªãã€ãƒšãƒ¼ã‚¸å…¨ä½“ã‚’çµæœè¡¨ç¤ºã«åˆ‡ã‚Šæ›¿ãˆã‚‹
Â  Â  Â  Â  Â  Â  Â  Â  closeModal(); // ã€Œé€ä¿¡ä¸­ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
Â  Â  Â  Â  Â  Â  Â  Â  showFinalResultsPage();

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("GASã¸ã®é€ä¿¡ã‚¨ãƒ©ãƒ¼:", error);
Â  Â  Â  Â  Â  Â  Â  Â  renderModal(`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="background:white; border-radius:1.5rem; padding:2rem; text-align:center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-xl font-bold text-red-600 mb-2">ä¿å­˜ã‚¨ãƒ©ãƒ¼</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-slate-600 font-bold mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  å›ç­”ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚<br>æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xs text-slate-500 mb-4">${error.message}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="show-results-anyway-button" class="action-button">çµæœã ã‘è¦‹ã‚‹</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('show-results-anyway-button').addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  playSound('click');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ã‚¨ãƒ©ãƒ¼æ™‚ã§ã‚‚ã€ãƒšãƒ¼ã‚¸å…¨ä½“ã‚’çµæœè¡¨ç¤ºã«åˆ‡ã‚Šæ›¿ãˆã‚‹
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  closeModal(); // ã‚¨ãƒ©ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(showFinalResultsPage, 300); // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‰ã˜ã‚‹ã®ã‚’å¾…ã£ã¦ã‹ã‚‰è¡¨ç¤º
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- SURVEY LOGIC ---
Â  Â  Â  Â  function startSurvey() {
Â  Â  Â  Â  Â  Â  closeModal();
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  const progressBarContainer = document.querySelector('.progress-bar-container');
Â  Â  Â  Â  Â  Â  Â  Â  if(progressBarContainer) progressBarContainer.style.display = 'none';

Â  Â  Â  Â  Â  Â  Â  Â  cardContainer.classList.remove('relative');
Â  Â  Â  Â  Â  Â  Â  Â  cardContainer.style.minHeight = 'auto';
Â  Â  Â  Â  Â  Â  Â  Â  cardContainer.innerHTML = `<div class="survey-shell">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="survey-content-area" class="survey-content-area"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  Â  Â  renderSurveyScreen(0, true);
Â  Â  Â  Â  Â  Â  }, 300);
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderSurveyScreen(index, isInitial = false) {
Â  Â  Â  Â  Â  Â  const screenData = surveyData[index];
Â  Â  Â  Â  Â  Â  if (!screenData) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Survey screen data not found for index:", index);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const contentHTML = buildSurveyScreenHTML(screenData);
Â  Â  Â  Â  Â  Â  const surveyContentArea = document.getElementById('survey-content-area');
Â  Â  Â  Â  Â  Â  if(!surveyContentArea) return;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const currentContentEl = surveyContentArea.querySelector('.survey-screen-content');
Â  Â  Â  Â  Â  Â  if (currentContentEl && !isInitial) {
Â  Â  Â  Â  Â  Â  Â  Â  currentContentEl.classList.add('content-out');
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  surveyContentArea.innerHTML = contentHTML;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newContentEl = surveyContentArea.querySelector('.survey-screen-content');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  newContentEl.classList.add('content-in');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  attachSurveyNavListeners();
Â  Â  Â  Â  Â  Â  Â  Â  }, 300);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  surveyContentArea.innerHTML = contentHTML;
Â  Â  Â  Â  Â  Â  Â  Â  const newContentEl = surveyContentArea.querySelector('.survey-screen-content');
Â  Â  Â  Â  Â  Â  Â  Â  if(newContentEl) newContentEl.classList.add('content-in');
Â  Â  Â  Â  Â  Â  Â  Â  attachSurveyNavListeners();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function buildSurveyScreenHTML(screenData) {
Â  Â  Â  Â  Â  Â  let optionsHTML = '';
Â  Â  Â  Â  Â  Â  const isQuestion = ['radio', 'likert', 'consent'].includes(screenData.type);
Â  Â  Â  Â  Â  Â  const savedAnswer = surveyAnswers[screenData.id];

Â  Â  Â  Â  Â  Â  if (screenData.type === 'radio' || screenData.type === 'consent') {
Â  Â  Â  Â  Â  Â  Â  Â  optionsHTML = `<div class="grid ${screenData.layout || 'grid-cols-1'} gap-4 mt-4">${screenData.options.map((opt, i) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const optionClass = opt.style === 'decline' ? 'survey-option-decline' : '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `<div style="animation-delay: ${i * 70 + 150}ms"><input type="radio" name="${screenData.id}" value="${opt.t}" class="survey-option-input hidden" id="opt-${screenData.id}-${i}" ${savedAnswer === opt.t ? 'checked' : ''}><label for="opt-${screenData.id}-${i}" class="survey-option-label ${optionClass}">${opt.i ? `<span class="icon">${opt.i}</span>` : ''}<span>${opt.t}</span></label></div>`
Â  Â  Â  Â  Â  Â  Â  Â  }).join('')}</div>`;
Â  Â  Â  Â  Â  Â  } else if (screenData.type === 'likert') {
Â  Â  Â  Â  Â  Â  Â  Â  const faces = ['ğŸ˜¥', 'ğŸ˜Ÿ', 'ğŸ˜', 'ğŸ™‚', 'ğŸ˜„'];
Â  Â  Â  Â  Â  Â  Â  Â  const leftAnnotationLabel = screenData.options.find(o => o.v === 1).l;
Â  Â  Â  Â  Â  Â  Â  Â  const rightAnnotationLabel = screenData.options.find(o => o.v === 5).l;
Â  Â  Â  Â  Â  Â  Â  Â  const middleAnnotationLabel = screenData.options.find(o => o.v === 3).l;

Â  Â  Â  Â  Â  Â  Â  Â  optionsHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="likert-horizontal-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="likert-emoji-bar">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${[1, 2, 3, 4, 5].map((v) => `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="radio" name="${screenData.id}" value="${v}" class="likert-emoji-input hidden" id="opt-${screenData.id}-${v}" ${savedAnswer == v ? 'checked' : ''}>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="opt-${screenData.id}-${v}" class="likert-emoji-label">${faces[v-1]}</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="likert-annotation-bar">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>${leftAnnotationLabel}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>${middleAnnotationLabel}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>${rightAnnotationLabel}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  let navigationHTML = '';
Â  Â  Â  Â  Â  Â  if (screenData.type === 'completion') {
Â  Â  Â  Â  Â  Â  Â  Â  navigationHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-6 flex flex-col items-center gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="survey-complete-button" class="survey-nav-button w-full max-w-xs">${screenData.buttonText}</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="survey-back-button" class="survey-nav-button survey-back-button w-1/2">æˆ»ã‚‹</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  } else if (screenData.type === 'section_header') {
Â  Â  Â  Â  Â  Â  Â  Â  Â navigationHTML = `<div class="h-16 mt-6"></div>`; // Placeholder for auto-advance
Â  Â  Â  Â  Â  Â  } else if (currentSurveyScreen > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â navigationHTML = `<div class="flex justify-center mt-6"><button id="survey-back-button" class="survey-nav-button survey-back-button w-1/2">æˆ»ã‚‹</button></div>`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â navigationHTML = `<div class="h-16 mt-6"></div>`; // Placeholder
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const questionScreens = surveyData.filter(s => s.type !== 'completion' && s.type !== 'section_header');
Â  Â  Â  Â  Â  Â  const currentQuestionIndex = questionScreens.findIndex(s => s.id === screenData.id);
Â  Â  Â  Â  Â  Â  const progress = isQuestion ? ((currentQuestionIndex + 1) / totalScreens) * 100 : (currentQuestionIndex / totalScreens) * 100;
Â  Â  Â  Â  Â  Â  const questionNumber = isQuestion ? currentQuestionIndex + 1 : currentQuestionIndex;

Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="survey-screen-content">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isQuestion ? `<p class="text-right text-sm font-bold text-indigo-400 mb-1">ã—ã¤ã‚‚ã‚“ ${questionNumber} / ${totalScreens}</p>` : '<p class="text-right text-sm font-bold text-indigo-400 mb-1">&nbsp;</p>'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="survey-progress-bar-container"><div style="width: ${progress}%" class="survey-progress-bar"></div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex-grow flex flex-col justify-center text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-extrabold text-slate-800 mb-2">${screenData.title || screenData.question}</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${(screenData.type === 'consent' && screenData.question) ? `<p class="text-sm text-slate-600 text-left">${screenData.question}</p>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${optionsHTML}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-4">${navigationHTML}</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function attachSurveyNavListeners() {
Â  Â  Â  Â  Â  Â  const backBtn = document.getElementById('survey-back-button');
Â  Â  Â  Â  Â  Â  const completeBtn = document.getElementById('survey-complete-button');

Â  Â  Â  Â  Â  Â  const screenData = surveyData[currentSurveyScreen];
Â  Â  Â  Â  Â  Â  if (!screenData) return;
Â  Â  Â  Â  Â  Â  const isQuestion = ['radio', 'likert', 'consent'].includes(screenData.type);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if(isQuestion) {
Â  Â  Â  Â  Â  Â  Â  Â  Â document.querySelectorAll(`.survey-option-label, .likert-emoji-label`).forEach(label => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  label.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const inputId = label.getAttribute('for');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const input = document.getElementById(inputId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!input || input.disabled) return;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const allInputsInGroup = document.querySelectorAll(`input[name="${input.name}"]`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allInputsInGroup.forEach(i => i.disabled = true);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  input.checked = true;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  playSound('click');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allInputsInGroup.forEach(i => i.disabled = false);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  handleSurveyNav('next');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 250);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  } else if (screenData.type === 'section_header') {
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => handleSurveyNav('next'), 800);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if(backBtn) backBtn.addEventListener('click', () => { playSound('click'); handleSurveyNav('back'); });
Â  Â  Â  Â  Â  Â  if(completeBtn) completeBtn.addEventListener('click', () => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  playSound('click');Â 
Â  Â  Â  Â  Â  Â  Â  Â  submitSurveyDataToGAS();
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // --- â˜…â˜…â˜… ä¿®æ­£å¾Œã®ã‚³ãƒ¼ãƒ‰ â˜…â˜…â˜… ---
Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * @function handleSurveyNav
Â  Â  Â  Â  Â * @description ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®ã€Œæ¬¡ã¸ã€ã€Œæˆ»ã‚‹ã€ã‚’åˆ¶å¾¡ã™ã‚‹ã€‚
Â  Â  Â  Â  Â * - 'next': ç¾åœ¨ã®å›ç­”ã‚’ä¿å­˜ã—ã€æ¬¡ã®ç”»é¢ã¸é€²ã‚€ã€‚
Â  Â  Â  Â  Â * - 'back': å‰ã®ç”»é¢ã¸æˆ»ã‚‹ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ã¯ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ï¼‰ã€‚
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function handleSurveyNav(direction) {
Â  Â  Â  Â  Â  Â  const surveyContentArea = document.getElementById('survey-content-area');
Â  Â  Â  Â  Â  Â  if (!surveyContentArea) return;
Â  Â  Â  Â  Â  Â  surveyContentArea.dataset.direction = direction;

Â  Â  Â  Â  Â  Â  if (direction === 'next') {
Â  Â  Â  Â  Â  Â  Â  Â  // ç¾åœ¨ã®ç”»é¢ã®å›ç­”ã‚’ä¿å­˜ã™ã‚‹
Â  Â  Â  Â  Â  Â  Â  Â  const screenData = surveyData[currentSurveyScreen];
Â  Â  Â  Â  Â  Â  Â  Â  if (screenData) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isQuestion = ['radio', 'likert', 'consent'].includes(screenData.type);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isQuestion) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const selected = document.querySelector(`input[name="${screenData.id}"]:checked`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (selected) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  surveyAnswers[screenData.id] = selected.value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // æ¬¡ã®ç”»é¢ã«é€²ã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
Â  Â  Â  Â  Â  Â  Â  Â  if (currentSurveyScreen < surveyData.length - 1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentSurveyScreen++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderSurveyScreen(currentSurveyScreen);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ã“ã®ãƒ­ã‚¸ãƒƒã‚¯ã¯å®Œäº†ç”»é¢ã®ãƒœã‚¿ãƒ³ã§å‡¦ç†ã•ã‚Œã‚‹ãŸã‚ã€é€šå¸¸ã¯ã“ã“ã«æ¥ãªã„
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn("ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®æœ€å¾Œã‚’è¶…ãˆã¦é€²ã‚‚ã†ã¨ã—ã¾ã—ãŸã€‚");
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  } else { // 'back'ã®å ´åˆ
Â  Â  Â  Â  Â  Â  Â  Â  // å‰ã®ç”»é¢ã«æˆ»ã‚Œã‚‹ã‹ãƒã‚§ãƒƒã‚¯
Â  Â  Â  Â  Â  Â  Â  Â  if (currentSurveyScreen > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentSurveyScreen--;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ã‚‚ã—æˆ»ã£ãŸå…ˆãŒã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ãªã‚‰ã€ã‚‚ã†ä¸€ã¤å‰ã«æˆ»ã‚‹
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (surveyData[currentSurveyScreen].type === 'section_header' && currentSurveyScreen > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentSurveyScreen--;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderSurveyScreen(currentSurveyScreen);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn("ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®æœ€åˆã‚ˆã‚Šå‰ã«æˆ»ã‚ã†ã¨ã—ã¾ã—ãŸã€‚");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // --- INITIALIZATION ---
Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  Â  Â  // LIFFãƒ­ã‚°ã‚¤ãƒ³ã‹ã‚‰ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå¾Œã®å¾©å…ƒå‡¦ç†
Â  Â  Â  Â  Â  Â  if (sessionStorage.getItem('isLiffLoginRedirect') === 'true') {
Â  Â  Â  Â  Â  Â  Â  Â  sessionStorage.removeItem('isLiffLoginRedirect');
Â  Â  Â  Â  Â  Â  Â  Â  const savedState = JSON.parse(sessionStorage.getItem('appState'));
Â  Â  Â  Â  Â  Â  Â  Â  if (savedState) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentScore = savedState.currentScore;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userSelections = savedState.userSelections;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  surveyAnswers = savedState.surveyAnswers;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sessionStorage.removeItem('appState');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã£ã¦ã€ç›´æ¥é€ä¿¡å‡¦ç†ã‚’å†é–‹
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  submitSurveyDataToGAS();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return; // é€šå¸¸ã®åˆæœŸåŒ–ã‚’ã‚¹ã‚­ãƒƒãƒ—
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â updateProgress();
Â  Â  Â  Â  Â  Â  Â renderCard(0);
Â  Â  Â  Â  });
Â  Â  </script>
</body>
</html>
