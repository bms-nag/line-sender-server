<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>å¤§è…¸ãŒã‚“èªè­˜åº¦ãƒã‚§ãƒƒã‚¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@500;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background: #EFF6FF;
            -webkit-user-select: none; 
            user-select: none;
            overflow-y: auto;
        }
        .game-board {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            padding: 1rem;
        }
        .progress-bar-container {
            width: 100%;
            background-color: #E0E7FF;
            border-radius: 9999px;
            height: 20px;
            border: 3px solid #C7D2FE;
            position: relative;
        }
        #progress-bar {
            background: linear-gradient(90deg, #A5B4FC, #818CF8);
            width: 0%;
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease-out;
        }
        #pupu-progress-icon {
            position: absolute;
            top: 50%;
            left: 0%;
            transform: translate(-50%, -50%);
            width: 48px;
            height: 48px;
            transition: left 0.5s ease-out;
        }
        .quiz-card {
            background: white;
            border-radius: 1.5rem;
            padding: 1.5rem;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        .btn-choice {
            border-radius: 9999px; font-weight: 800; font-size: 1.5rem; padding: 0.75rem 0;
            cursor: pointer; transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 6px 0 0; border: 3px solid white;
        }
        .btn-choice:active { transform: translateY(4px); box-shadow: 0 2px 0 0; }
        .btn-o { background-color: #fb7185; color: white; box-shadow-color: #e11d48; }
        .btn-x { background-color: #38bdf8; color: white; box-shadow-color: #0284c7; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(8px);
            display: flex; align-items: center; justify-content: center;
            z-index: 50; opacity: 0; pointer-events: none; transition: opacity 0.3s ease-out;
            padding: 1rem;
        }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-content {
            background: transparent;
            width: 100%;
            max-width: 500px;
            transform: scale(0.95); transition: transform 0.3s ease-out;
        }
        .modal-overlay.visible .modal-content { transform: scale(1); }

        .action-button {
            background: linear-gradient(180deg, #F9A8D4, #F472B6);
            color: white; border-radius: 9999px; padding: 0.75rem 2rem;
            font-weight: 800; font-size: 1.125rem; box-shadow: 0 5px 0 #DB2777;
            border: 2px solid white; cursor: pointer; transition: all 0.1s ease-out;
        }
        .action-button:active { transform: translateY(3px); box-shadow: 0 2px 0 #DB2777; }
        
        /* --- Survey Styles --- */
        .survey-container-wrapper { width: 100%; position: relative; }
        .survey-shell { min-height: 500px; display: flex; flex-direction: column; background: white; border-radius: 1.5rem; padding: 1.5rem; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05), 0 20px 20px -10px rgba(99, 102, 241, 0.2); border: 1px solid #e0e7ff; }
        .survey-content-area { position: relative; flex-grow: 1; display: flex; flex-direction: column; }
        .survey-screen-content { display: flex; flex-direction: column; flex-grow: 1; }
        .survey-progress-bar-container { width: 100%; background-color: #e5e7eb; border-radius: 9999px; height: 12px; overflow: hidden; border: 2px solid #e0e7ff;}
        .survey-progress-bar { background: linear-gradient(to right, #818cf8, #a78bfa); height: 100%; border-radius: 9999px; transition: width 0.4s ease-out; }
        .survey-option-label { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.5rem; padding: 1rem 0.5rem; border-radius: 1rem; background-color: #f3f4f6; cursor: pointer; transition: all 0.2s ease-out; font-size: 1rem; font-weight: 700; border: 2px solid transparent; min-height: 80px; }
        .survey-option-label .icon { font-size: 2rem; line-height: 1; }
        .survey-option-label:hover { background-color: #e5e7eb; transform: scale(1.02); }
        .survey-option-input:checked + .survey-option-label { background-color: #e0e7ff; color: #4338ca; border-color: #6366f1; animation: pop-select 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .likert-horizontal-container { width: 100%; margin: 2rem 0; }
        .likert-emoji-bar { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background-color: #f3f4f6; border-radius: 9999px; }
        .likert-emoji-label { font-size: 2.5rem; cursor: pointer; transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); filter: grayscale(80%); opacity: 0.6; }
        .likert-emoji-input:checked + .likert-emoji-label { transform: scale(1.4); filter: grayscale(0%); opacity: 1; }
        .likert-annotation-bar { display: flex; justify-content: space-between; padding: 0 0.5rem; margin-top: 0.5rem; font-size: 0.75rem; font-weight: 700; color: #6b7280; }
        .survey-nav-button { background: linear-gradient(180deg, #818cf8, #6366f1); color: white; font-weight: 800; padding: 1rem; border-radius: 9999px; box-shadow: 0 5px 0 #4f46e5; transition: all 0.15s ease-out; font-size: 1.1rem; }
        .survey-nav-button:active { transform: translateY(3px); box-shadow: 0 2px 0 #4f46e5; }
        .survey-back-button { background: linear-gradient(180deg, #d1d5db, #9ca3af); box-shadow: 0 5px 0 #6b7280; }
        .survey-back-button:active { transform: translateY(3px); box-shadow: 0 2px 0 #6b7280; }
        
        .survey-option-decline {
            background-color: #f9fafb;
            color: #9ca3af;
            font-size: 0.9rem;
            border: 2px solid #f3f4f6;
        }
        .survey-option-decline:hover {
            background-color: #f3f4f6;
        }
        .survey-option-input:checked + .survey-option-decline {
            background-color: #e5e7eb;
            color: #6b7280;
            border-color: #d1d5db;
        }

        /* --- Animations --- */
        @keyframes content-fade-out { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-10px); } }
        @keyframes content-fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .content-out { animation: content-fade-out 0.3s ease-out forwards; }
        .content-in { animation: content-fade-in 0.4s ease-out forwards; }
        @keyframes pop-select { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes pupu-breathing { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes blinking-next { 0% { transform: scale(1); box-shadow: 0 5px 0 var(--shadow-color), 0 0 0 0 rgba(34, 197, 94, 0.7); } 70% { transform: scale(1.05); box-shadow: 0 5px 0 var(--shadow-color), 0 0 0 15px rgba(34, 197, 94, 0); } 100% { transform: scale(1); box-shadow: 0 5px 0 var(--shadow-color), 0 0 0 0 rgba(34, 197, 94, 0); } }
        .blinking-next-button { animation: blinking-next 1.5s infinite; }
    </style>
</head>
<body>
    <div class="game-board">
        <header class="text-center my-4"><h1 class="text-2xl font-extrabold text-slate-700">å¤§è…¸ãŒã‚“èªè­˜åº¦ãƒã‚§ãƒƒã‚¯</h1></header>
        <div class="progress-bar-container mb-4">
            <div id="progress-bar"></div>
            <img id="pupu-progress-icon" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3Cfilter id='dropShadow' x='-20%25' y='-20%25' width='140%25' height='140%25'%3E%3CfeDropShadow dx='2' dy='4' stdDeviation='2' flood-color='%23000000' flood-opacity='0.2'/%3E%3C/filter%3E%3CradialGradient id='poopGradient' cx='0.5' cy='1' r='1'%3E%3Cstop offset='0%25' stop-color='%23A1887F'/%3E%3Cstop offset='100%25' stop-color='%235D4037'/%3E%3C/radialGradient%3E%3C/defs%3E%3Cg filter='url(%23dropShadow)'%3E%3Cpath d='M50 95 C 20 95, 20 65, 50 65 C 80 65, 80 95, 50 95 Z' fill='url(%23poopGradient)'/%3E%3Cpath d='M50 70 C 28 70, 28 45, 50 45 C 72 45, 72 70, 50 70 Z' fill='url(%23poopGradient)'/%3E%3Cpath d='M50 50 C 38 50, 38 30, 50 30 C 62 30, 62 50, 50 50 Z' fill='url(%23poopGradient)'/%3E%3Ccircle cx='38' cy='68' r='7' fill='white'/%3E%3Ccircle cx='62' cy='68' r='7' fill='white'/%3E%3Ccircle cx='39' cy='69' r='4' fill='black'/%3E%3Ccircle cx='61' cy='69' r='4' fill='black'/%3E%3Cpath d='M45 82 Q 50 88 55 82' stroke='white' stroke-width='3' fill='none' stroke-linecap='round'/%3E%3C/g%3E%3C/svg%3E" alt="ã·ã·ã‚¢ã‚¤ã‚³ãƒ³">
        </div>
        <div id="card-container" class="relative" style="min-height: 450px;"></div>
    </div>
    <div id="modal-container"></div>
    
    <script>
        // --- CONFIGURATION ---
        const LIFF_ID = "2007757059-nepa16EO";
        const LINE_ACCOUNT_URL = "https://lin.ee/NmU3RyA";
        
        // â˜…â˜…â˜… ã“ã“ã‚’å¿…ãšã€GASã®ã€Œæ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ã€ã€‘ã§ç™ºè¡Œã•ã‚ŒãŸæœ€æ–°ã®URLã«æ›¸ãæ›ãˆã¦ãã ã•ã„ â˜…â˜…â˜…
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzkbiivJ-j7dDT5wXy9FwSF2NAsA_Cb_yGcEJaAPZSoaY8e0qaNxB85Z3_Z42WF0Ycw/exec";

        const quizData = [
            { question: "å¤§è…¸ãŒã‚“ã®åˆæœŸã«ã¯ã€å¿…ãšãŠè…¹ã®ç—›ã¿ã‚„è¡€ä¾¿ãªã©ã®è‡ªè¦šç—‡çŠ¶ãŒã‚ã‚‹ã€‚", correctAnswer: "Ã—", explanation: "åˆæœŸã¯ç—‡çŠ¶ãŒãªã„ã“ã¨ãŒå¤šã„ã‚“ã ã€‚ã ã‹ã‚‰æ¤œè¨ºãŒå¤§äº‹ï¼", illustration: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='55' font-size='50' text-anchor='middle' dominant-baseline='middle'%3EğŸ¤«%3C/text%3E%3C/svg%3E`, explanationIllustration: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='55' font-size='50' text-anchor='middle'%3EğŸ‘»%3C/text%3E%3C/svg%3E`},
            { question: "ä¾¿æ½œè¡€æ¤œæŸ»ã§ã€Œç•°å¸¸ãªã—ã€ãªã‚‰ã€ã‚‚ã†å¤§è…¸ãŒã‚“ã®å¿ƒé…ã¯ã‚¼ãƒ­ã ï¼", correctAnswer: "Ã—", explanation: "ä¾¿æ½œè¡€æ¤œæŸ»ã ã‘ã˜ã‚ƒè¦‹é€ƒã™ã“ã¨ã‚‚ã€‚æ°—ã«ãªã‚‹ãªã‚‰ç²¾å¯†æ¤œæŸ»ã‚‚è€ƒãˆã‚ˆã†ï¼", illustration: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='55' font-size='50' text-anchor='middle' dominant-baseline='middle'%3EğŸ§ª%3C/text%3E%3C/svg%3E`, explanationIllustration: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='55' font-size='50' text-anchor='middle'%3EğŸ”¬%3C/text%3E%3C/svg%3E`},
            { question: "å¤§è…¸ãŒã‚“ã¯ã€ãŠã˜ã„ã¡ã‚ƒã‚“ãŠã°ã‚ã¡ã‚ƒã‚“ã®ç—…æ°—ã€‚è‹¥ã„äººã¯é–¢ä¿‚ãªã„ï¼", correctAnswer: "Ã—", explanation: "ãã‚“ãªã“ã¨ãªã„ï¼æœ€è¿‘ã¯è‹¥ã„äººã§ã‚‚å¢—ãˆã¦ã‚‹ã‹ã‚‰æ²¹æ–­ã¯ç¦ç‰©ã ã‚ˆã€‚", illustration: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='55' font-size='50' text-anchor='middle' dominant-baseline='middle'%3EğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦%3C/text%3E%3C/svg%3E`, explanationIllustration: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='55' font-size='50' text-anchor='middle'%3EğŸ§‘%3C/text%3E%3C/svg%3E`},
            { question: "å¤§è…¸ã‚«ãƒ¡ãƒ©ï¼ˆå†…è¦–é¡ï¼‰ã€å¤§è…¸CTã£ã¦ã€ã‚‚ã®ã™ã”ãƒ¼ãç—›ãã¦å¤§å¤‰ãªæ¤œæŸ»ã ï¼", correctAnswer: "Ã—", explanation: "ä»Šã¯éº»é…”ã§æ¥½ã«å—ã‘ã‚‰ã‚Œã‚‹ç—…é™¢ãŒå¤šã„ã‚“ã ã€‚CTæ¤œæŸ»ã‚‚ã‚ã‚‹ã‚ˆï¼", illustration: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='55' font-size='50' text-anchor='middle' dominant-baseline='middle'%3EğŸ˜´%3C/text%3E%3C/svg%3E`, explanationIllustration: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='55' font-size='50' text-anchor='middle'%3EğŸ˜Œ%3C/text%3E%3C/svg%3E`},
            { question: "ãƒãƒªãƒ¼ãƒ—ãŒè¦‹ã¤ã‹ã£ã¦ã‚‚ã€å…¨éƒ¨ãŒãŒã‚“ã«ãªã‚‹ã‚ã‘ã˜ã‚ƒãªã„ã‹ã‚‰ã€æ”¾ã£ã¦ãŠã„ã¦ã‚‚å¹³æ°—ï¼", correctAnswer: "Ã—", explanation: "ãŒã‚“ã«ãªã‚‹ãƒãƒªãƒ¼ãƒ—ã‚‚ã‚ã‚‹ã‹ã‚‰ã€ãŠåŒ»è€…ã•ã‚“ã®æŒ‡ç¤ºã«å¾“ã£ã¦ã­ã€‚", illustration: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='55' font-size='50' text-anchor='middle' dominant-baseline='middle'%3Eâš ï¸%3C/text%3E%3C/svg%3E`, explanationIllustration: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='55' font-size='50' text-anchor='middle'%3EğŸ‘¨â€âš•ï¸%3C/text%3E%3C/svg%3E`},
            { question: "å®¶æ—ã«ãŒã‚“ã®äººãŒã„ãªãã‚ƒã€è‡ªåˆ†ã¯éºä¼çš„ã«å®‰å¿ƒã ï¼", correctAnswer: "Ã—", explanation: "éºä¼ã ã‘ã˜ã‚ƒãªã„ï¼é£Ÿç”Ÿæ´»ã‚„é‹å‹•ä¸è¶³ã‚‚å¤§ããªåŸå› ã«ãªã‚‹ã‚“ã ã€‚", illustration: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='55' font-size='50' text-anchor='middle' dominant-baseline='middle'%3EğŸ§¬%3C/text%3E%3C/svg%3E`, explanationIllustration: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='55' font-size='50' text-anchor='middle' dominant-baseline='middle'%3EğŸ”%3C/text%3E%3C/svg%3E`},
            { question: "é‹å‹•ã¯ã€å¤§è…¸ãŒã‚“ã®äºˆé˜²ã«åŠ¹æœãŒã‚ã‚‹ã€‚", correctAnswer: "â—‹", explanation: "å®šæœŸçš„ãªé‹å‹•ã¯ã€ãŒã‚“ã®ãƒªã‚¹ã‚¯ã‚’ä¸‹ã’ã‚‹ã“ã¨ãŒçŸ¥ã‚‰ã‚Œã¦ã„ã‚‹ã‚ˆã€‚æ—¥ã€…ã®ç”Ÿæ´»ã«é‹å‹•ã‚’å–ã‚Šå…¥ã‚Œã‚ˆã†ï¼", illustration: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='55' font-size='50' text-anchor='middle' dominant-baseline='middle'%3EğŸƒâ€â™‚ï¸%3C/text%3E%3C/svg%3E`, explanationIllustration: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='55' font-size='50' text-anchor='middle'%3EğŸ’ª%3C/text%3E%3C/svg%3E`},
            { question: "ä¸€å›æ¤œæŸ»ã—ã¦OKã ã£ãŸã‚‰ã€ã‚‚ã†ä¸€ç”Ÿæ¤œæŸ»ã—ãªãã¦ã„ã„ï¼", correctAnswer: "Ã—", explanation: "ä½“ã¯å¤‰åŒ–ã™ã‚‹ã‹ã‚‰ã€å®šæœŸçš„ãªãƒã‚§ãƒƒã‚¯ãŒå¤§åˆ‡ãªã‚“ã ã‚ˆã€‚", illustration: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='55' font-size='50' text-anchor='middle' dominant-baseline='middle'%3EğŸ—“ï¸%3C/text%3E%3C/svg%3E`, explanationIllustration: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='55' font-size='50' text-anchor='middle'%3EğŸ”„%3C/text%3E%3C/svg%3E`}
        ];
        const surveyData = [
            { screen: 1, type: 'radio', id: 'A-1_age', question: 'ã‚ãªãŸã®å¹´ä»£ã‚’æ•™ãˆã¦ï¼', options: [{t:'20ä»£ä»¥ä¸‹'}, {t:'30ä»£'}, {t:'40ä»£'}, {t:'50ä»£'}, {t:'60ä»£'}, {t:'70ä»£ä»¥ä¸Š'}], layout: 'grid-cols-3' },
            { screen: 2, type: 'radio', id: 'A-2_gender', question: 'ã‚ãªãŸã®æ€§åˆ¥ã¯ã©ã£ã¡ã‹ãªï¼Ÿ', options: [{t:'ç”·æ€§',i:'â™‚ï¸'}, {t:'å¥³æ€§',i:'â™€ï¸'}, {t:'ãã®ä»–',i:'ğŸŒˆ'}, {t:'å›ç­”ã—ãªã„',i:'ğŸ¤«'}], layout: 'grid-cols-2' },
            { screen: 3, type: 'radio', id: 'A-3_local_exam', question: 'è‡ªæ²»ä½“ã‚„è·å ´ã®æ¤œè¨ºï¼ˆä¾¿æ½œè¡€æ¤œæŸ»ï¼‰ã€å—ã‘ãŸã“ã¨ã‚ã‚‹ï¼Ÿ', options: [{t:'ã‚ã‚‹',i:'ğŸ‘'}, {t:'ãªã„',i:'âŒ'}, {t:'ã‚ã‹ã‚‰ãªã„',i:'ğŸ¤”'}], layout: 'grid-cols-3' },
            { screen: 4, type: 'radio', id: 'A-4_scope_exam', question: 'ç—…é™¢ã§è©³ã—ã„æ¤œæŸ»ï¼ˆå¤§è…¸ã‚«ãƒ¡ãƒ©ãƒ»å¤§è…¸CTï¼‰ã‚’ã—ãŸã“ã¨ã‚ã‚Šã¾ã™ã‹ï¼Ÿ', options: [{t:'ã‚ã‚‹',i:'ğŸ‘'}, {t:'ãªã„',i:'âŒ'}, {t:'ã‚ã‹ã‚‰ãªã„',i:'ğŸ¤”'}], layout: 'grid-cols-3' },
            { screen: 5, type: 'radio', id: 'A-5_family_history', question: 'è¡€ã®ã¤ãªãŒã£ãŸå®¶æ—ã«å¤§è…¸ãŒã‚“ã®äººã€ã„ã‚‹ï¼Ÿ', options: [{t:'ã„ã‚‹',i:'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦'}, {t:'ã„ãªã„',i:'âŒ'}, {t:'ã‚ã‹ã‚‰ãªã„',i:'ğŸ¤”'}], layout: 'grid-cols-3' },
            { screen: 6, type: 'section_header', title: 'å¾ŒåŠæˆ¦ï¼' },
            { screen: 7, type: 'likert', id: 'B-1-1_intention', question: '1å¹´ä»¥å†…ã«å¤§è…¸ãŒã‚“æ¤œè¨ºã€å—ã‘ã¦ã¿ãŸã„ï¼Ÿ', options: [{ v: 1, l: 'å…¨ãå—ã‘ãŸããªã„' }, { v: 2, l: 'ã‚ã¾ã‚Šå—ã‘ãŸããªã„' }, { v: 3, l: 'ã©ã¡ã‚‰ã¨ã‚‚ã„ãˆãªã„' }, { v: 4, l: 'ã§ãã‚Œã°å—ã‘ãŸã„' }, { v: 5, l: 'ãœã²å—ã‘ãŸã„' }] },
            { screen: 8, type: 'likert', id: 'B-2-1_risk', question: 'å°†æ¥ã€è‡ªåˆ†ãŒå¤§è…¸ãŒã‚“ã«ãªã‚‹å¯èƒ½æ€§ã€ã©ã†æ€ã†ï¼Ÿ', options: [{ v: 1, l: 'é«˜ã„ã¨æ€ã†' }, { v: 2, l: 'ã‚„ã‚„é«˜ã„ã¨æ€ã†' }, { v: 3, l: 'ä»–ã®äººã¨åŒã˜ãã‚‰ã„' }, { v: 4, l: 'ã‚ã¾ã‚Šé«˜ããªã„' }, { v: 5, l: 'ã»ã¨ã‚“ã©ãªã„' }] },
            { screen: 9, type: 'likert', id: 'B-3-1_barrier_burden', question: 'è©³ã—ã„æ¤œæŸ»ï¼ˆå¤§è…¸ã‚«ãƒ¡ãƒ©ãƒ»å¤§è…¸CTï¼‰ã£ã¦ã€ç—›ã‹ã£ãŸã‚Šå¤§å¤‰ãã†ï¼Ÿ', options: [{ v: 1, l: 'éå¸¸ã«ãã†æ€ã†' }, { v: 2, l: 'ã‚„ã‚„ãã†æ€ã†' }, { v: 3, l: 'ã©ã¡ã‚‰ã¨ã‚‚ã„ãˆãªã„' }, { v: 4, l: 'ã‚ã¾ã‚Šæ€ã‚ãªã„' }, { v: 5, l: 'å…¨ãæ€ã‚ãªã„' }] },
            { screen: 10, type: 'likert', id: 'B-4-1_self_efficacy_prep', question: 'ã‚‚ã—ãŠåŒ»è€…ã•ã‚“ã«å‹§ã‚ã‚‰ã‚ŒãŸã‚‰ã€æ¤œæŸ»ã®æº–å‚™ã€ã¡ã‚ƒã‚“ã¨ã§ããã†ï¼Ÿ', options: [{ v: 1, l: 'å…¨ãè‡ªä¿¡ãŒãªã„' }, { v: 2, l: 'ã‚ã¾ã‚Šè‡ªä¿¡ãŒãªã„' }, { v: 3, l: 'ã©ã¡ã‚‰ã¨ã‚‚ã„ãˆãªã„' }, { v: 4, l: 'ãŸã¶ã‚“ã§ãã‚‹' }, { v: 5, l: 'çµ¶å¯¾ã«ã§ãã‚‹' }] },
            { screen: 11, type: 'consent', id: 'consent', title: 'æœ€å¾Œã®ãŠé¡˜ã„ï¼', question: 'ã”å›ç­”ã„ãŸã ã„ãŸå†…å®¹ã¯ã€å€‹äººãŒç‰¹å®šã•ã‚Œãªã„çµ±è¨ˆæƒ…å ±ã¨ã—ã¦ã€ä»Šå¾Œã®ç ”ç©¶æ´»å‹•ã‚„ã‚µãƒ¼ãƒ“ã‚¹æ”¹å–„ï¼ˆå•†æ¥­åˆ©ç”¨ã‚’å«ã‚€ï¼‰ã®ãŸã‚ã«æ´»ç”¨ã•ã›ã¦ã„ãŸã ãå ´åˆãŒã”ã–ã„ã¾ã™ã€‚<br><br>ã“ã®ç‚¹ã«ã¤ã„ã¦ã€ã”åŒæ„ã„ãŸã ã‘ã¾ã™ã§ã—ã‚‡ã†ã‹ï¼Ÿ', options: [{t:'ã¯ã„ï¼ˆåŒæ„ã™ã‚‹ï¼‰',i:'ğŸ¤'}, {t:'ã„ã„ãˆï¼ˆåŒæ„ã—ãªã„ï¼‰', style: 'decline'}], layout: 'grid-cols-2' },
            { screen: 12, type: 'completion', title: 'ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå®Œäº†ï¼<br>å”åŠ›ã‚ã‚ŠãŒã¨ã†ï¼', buttonText: 'å›ç­”ã‚’é€ä¿¡ã—ã¦çµæœã«æˆ»ã‚‹' }
        ];
        const totalScreens = surveyData.filter(s => ['radio', 'likert', 'consent'].includes(s.type)).length;

        // --- ELEMENTS & STATE ---
        const cardContainer = document.getElementById('card-container');
        const modalContainer = document.getElementById('modal-container');
        const progressBar = document.getElementById('progress-bar');
        const pupuIcon = document.getElementById('pupu-progress-icon');
        let currentQIndex = 0;
        let currentScore = 0;
        let userSelections = {};
        let surveyAnswers = {};
        let currentSurveyScreen = 0;
        let liffUserId = "unknown_user"; // Global user ID

        // --- SOUNDS ---
        const correctSound = new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1}, volume: -10 }).toDestination();
        const wrongSound = new Tone.Synth({ oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.2 }, volume: -15 }).toDestination();
        const clickSound = new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 2, volume: -18 }).toDestination();
        function playSound(type) {
            if (Tone.context.state !== 'running') { Tone.context.resume(); }
            if(type === 'correct') correctSound.triggerAttackRelease("G4", "16n");
            else if(type === 'wrong') wrongSound.triggerAttackRelease("C3", "8n");
            else clickSound.triggerAttackRelease("C4", "32n");
        }
        
        // --- TEMPLATES & RENDERING ---
        function renderCard(index) {
            const q = quizData[index];
            const cardHTML = `<div id="quiz-card-${index}" class="quiz-card absolute w-full h-full flex flex-col items-center justify-between"><div class="text-left w-full"><p class="text-sm font-bold text-indigo-500">ã‚‚ã‚“ã ã„ ${index + 1}</p><h2 class="text-xl font-extrabold text-slate-700 mt-2">${q.question}</h2></div><img src="${q.illustration}" class="w-28 h-28 my-4"><div class="grid grid-cols-2 gap-4 w-full"><button class="btn-choice btn-o" data-value="â—‹">â—‹</button><button class="btn-choice btn-x" data-value="Ã—">Ã—</button></div></div>`;
            cardContainer.innerHTML = cardHTML;
            attachCardListeners(index);
        }

        function renderModal(content, addListeners = true) {
            modalContainer.innerHTML = `<div class="modal-overlay"><div class="modal-content">${content}</div></div>`;
            setTimeout(() => {
                const overlay = modalContainer.querySelector('.modal-overlay');
                if (overlay) overlay.classList.add('visible');
            }, 10);
            if(addListeners) attachModalListeners();
        }

        function closeModal() {
            const overlay = modalContainer.querySelector('.modal-overlay');
            if(overlay) {
                overlay.classList.remove('visible');
                setTimeout(() => { modalContainer.innerHTML = ''; }, 300);
            }
        }

        function updateProgress() {
            const progress = ((currentQIndex) / quizData.length) * 100;
            progressBar.style.width = `${progress}%`;
            pupuIcon.style.left = `${progress}%`;
        }

        const templates = {};

        templates.linePrompt = `
            <div style="background:white; border-radius:1.5rem; padding:2rem;">
                <div class="text-center">
                    <h2 class="text-xl font-bold text-green-600 mb-2">è¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆã®å‰ã«ï¼</h2>
                    <p class="text-slate-600 font-bold mb-6 text-sm">
                        çµæœã‚’è¦‹ã‚‹ã«ã¯ã€LINEã®ãŠå‹é”ç™»éŒ²ã‚’ãŠé¡˜ã„ã—ã¾ã™ï¼<br>å½¹ç«‹ã¤å¥åº·æƒ…å ±ã‚‚ãŠå±Šã‘ã—ã¾ã™ã€‚
                    </p>
                    <div class="space-y-3">
                        <button id="line-register-button" class="action-button w-full" style="background: linear-gradient(180deg, #4ade80, #22c55e); box-shadow-color: #15803d;">
                            LINEç™»éŒ²ã—ã¦ã€çµæœã‚’è¦‹ã‚‹
                        </button>
                    </div>
                </div>
            </div>`;

        templates.lineThanks = `
            <div style="background:white; border-radius:1.5rem; padding:2rem;">
                <div class="text-center">
                    <h2 class="text-xl font-bold text-green-600 mb-2">ã‚ã‚ŠãŒã¨ã†ï¼</h2>
                    <p class="text-slate-600 font-bold mb-4">
                        ä¸‹ã®ãƒœã‚¿ãƒ³ã§çµæœã‚’ç¢ºèªã—ã¦ã­ã€‚
                    </p>
                    <button id="show-results-button" class="action-button w-full">
                        çµæœã‚’è¦‹ã‚‹
                    </button>
                </div>
            </div>`;

        templates.results = (score, selections, showSurveyButton = true) => {
            const percentage = Math.round((score / quizData.length) * 100);
            let resultEmoji = percentage >= 80 ? 'ğŸ¥³' : (percentage < 40 ? 'ğŸ˜¥' : 'ğŸ¤”');
            const resultsHTML = quizData.map((item, i) => {
                const isCorrect = selections[i] === item.correctAnswer;
                return `<div class="p-4 rounded-2xl ${isCorrect ? 'bg-green-50' : 'bg-red-50'} border-2 ${isCorrect ? 'border-green-200' : 'border-red-200'}"><p class="font-bold text-slate-700 text-sm text-left">${item.question}</p><div class="grid grid-cols-2 gap-3 text-center my-3"><div class="p-2 rounded-xl bg-white/80"><p class="text-slate-500 font-bold text-xs">ã‚ãªãŸã®ç­”ãˆ</p><p class="text-5xl font-extrabold ${isCorrect ? 'text-slate-700' : 'text-red-500'}">${selections[i]}</p></div><div class="p-2 rounded-xl bg-white/80"><p class="text-slate-500 font-bold text-xs">æ­£è§£ã¯...</p><p class="text-5xl font-extrabold text-amber-500">${item.correctAnswer}</p></div></div><div class="mt-2 text-left p-3 bg-white/50 rounded-xl flex items-center gap-3"><img src="${item.explanationIllustration}" class="w-12 h-12 flex-shrink-0"><p class="text-sm font-bold text-slate-600 flex-1">${item.explanation}</p></div></div>`;
            }).join('');
            
            const buttonHTML = showSurveyButton 
                ? `<div class="mt-6 text-center"><button id="start-survey-button" class="action-button text-xl w-full max-w-xs mx-auto blinking-next-button" style="background: linear-gradient(180deg, #4ade80, #22c55e); --shadow-color: #15803d; padding: 1rem 2rem;">æ¬¡ã¸ï¼</button></div>`
                : `<div class="mt-6 text-center"><button id="close-final-results-button" class="action-button text-xl w-full max-w-xs mx-auto" style="background: linear-gradient(180deg, #a78bfa, #8b5cf6); box-shadow-color: #6d28d9; padding: 1rem 2rem;">é–‰ã˜ã‚‹</button></div>`;

            return `<div style="background:white; border-radius:1.5rem; padding:1rem;"><div class="w-full h-full flex flex-col p-2"><div class="text-center mb-2"><p class="text-6xl">${resultEmoji}</p><h2 class="text-lg font-bold text-slate-700">${percentage >= 80 ? 'ã™ã”ã„ï¼çŸ¥è­˜ã‚«ãƒ³ãƒšã‚­ï¼' : (percentage >= 40 ? 'ãŠã—ã„ï¼ã‚ã¨ã‚‚ã†ã¡ã‚‡ã£ã¨ï¼' : 'ã¾ã ã¾ã ã®ã³ã—ã‚ã‚ã‚Šï¼')}</h2><p class="text-4xl font-extrabold text-amber-500">${score}<span class="text-xl">/${quizData.length}å•æ­£è§£</span></p></div><div class="space-y-3 overflow-y-auto flex-grow max-h-[50vh] p-1">${resultsHTML}</div>${buttonHTML}</div></div>`;
        };

        // --- EVENT LISTENERS ---
        function attachCardListeners(index) { 
            document.getElementById(`quiz-card-${index}`).querySelectorAll('.btn-choice').forEach(btn => btn.addEventListener('click', e => {
                if (e.currentTarget.parentElement.parentElement.dataset.answered) return;
                e.currentTarget.parentElement.parentElement.dataset.answered = 'true';
                handleAnswer(index, e.target.dataset.value);
            }));
        }
        
        function attachModalListeners() {
            const listeners = {
                '#line-register-button': () => {
                    playSound('click');
                    window.open(LINE_ACCOUNT_URL, '_blank');
                    renderModal(templates.lineThanks);
                },
                '#show-results-button': () => {
                    playSound('click');
                    renderModal(templates.results(currentScore, userSelections, true));
                },
                '#start-survey-button': () => {
                    playSound('click');
                    startSurvey();
                },
                '#close-final-results-button': () => {
                    playSound('click');
                    closeModal();
                }
            };
            for (const selector in listeners) {
                const el = document.querySelector(selector);
                if (el) el.addEventListener('click', listeners[selector]);
            }
        }
        
        // --- CORE LOGIC ---
        function handleAnswer(index, value) {
            userSelections[index] = value;
            if (value === quizData[index].correctAnswer) { playSound('correct'); currentScore++; } else { playSound('wrong'); }
            const card = document.getElementById(`quiz-card-${index}`);
            card.style.opacity = '0';
            card.style.transform = 'scale(0.9)';
            setTimeout(() => {
                currentQIndex++; updateProgress();
                if (currentQIndex < quizData.length) { renderCard(currentQIndex); } 
                else {
                    cardContainer.innerHTML = `<div class="quiz-card flex items-center justify-center text-center"><h2 class="text-2xl font-extrabold text-slate-700">ãŠã¤ã‹ã‚Œã•ã¾ï¼<br>è¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã™ã‚‹ã‚ˆï¼</h2></div>`;
                    setTimeout(() => {
                          renderModal(templates.linePrompt);
                    }, 800);
                }
            }, 300);
        }

        function showFinalResultsPage() {
            const mainProgressBar = document.querySelector('.progress-bar-container');
            if (mainProgressBar) mainProgressBar.style.display = 'none';

            cardContainer.innerHTML = templates.results(currentScore, userSelections, false);
            cardContainer.classList.remove('relative');
            cardContainer.style.minHeight = 'auto';

            const closeButton = document.getElementById('close-final-results-button');
            if (closeButton) {
                closeButton.addEventListener('click', () => {
                    playSound('click');
                    cardContainer.innerHTML = `<div class="survey-shell flex items-center justify-center text-center" style="min-height: 500px;">
                        <h2 class="text-2xl font-extrabold text-slate-700">ã”å”åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼<br>ã“ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã¦ãã ã•ã„ã€‚</h2>
                    </div>`;
                    if (typeof liff !== 'undefined' && liff.isInClient()) {
                        setTimeout(() => liff.closeWindow(), 2000);
                    }
                });
            }
        }

        // LIFF Initialize Function
        async function initializeLiff() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    liffUserId = profile.userId;
                    console.log("LIFF Initialized. User ID:", liffUserId);
                } else {
                    console.log("LIFF Initialized but not logged in.");
                }
            } catch (err) {
                console.warn("LIFF Initialization failed:", err);
            }
        }

        async function handleLogin() {
             try {
                if (!liff.isLoggedIn()) {
                    const stateToSave = {
                        currentScore: currentScore,
                        userSelections: userSelections,
                        surveyAnswers: surveyAnswers
                    };
                    sessionStorage.setItem('appState', JSON.stringify(stateToSave));
                    sessionStorage.setItem('isLiffLoginRedirect', 'true');
                    liff.login({ redirectUri: window.location.href });
                } else {
                    // Already logged in, just submit
                    submitSurveyDataToGAS();
                }
            } catch (err) {
                console.error("Login failed", err);
                // Fallback if login fails locally
                submitSurveyDataToGAS(); 
            }
        }

        /**
         * @function submitSurveyDataToGAS
         * @description ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’GASã«é€ä¿¡ã™ã‚‹é–¢æ•°ï¼ˆãƒ‡ãƒãƒƒã‚°å¼·åŒ–ç‰ˆï¼‰
         */
        async function submitSurveyDataToGAS() {
            renderModal(`
                <div style="background:white; border-radius:1.5rem; padding:2rem; text-align:center;">
                    <h2 class="text-xl font-bold text-indigo-600 mb-2">é€ä¿¡ä¸­...</h2>
                    <p id="save-status" class="text-slate-600 font-bold mb-4">å°‘ã—å¾…ã£ã¦ã­</p>
                    <div class="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-indigo-500 mx-auto"></div>
                </div>
            `, false);

            try {
                // Use global liffUserId if available, otherwise 'unknown_user'
                // Do NOT call liff.init() here to avoid "authorization code expired" errors
                
                const quizResults = quizData.map((q, index) => {
                    const userAnswer = userSelections[index] || "æœªå›ç­”";
                    return {
                        question: q.question,
                        userAnswer: userAnswer,
                        correctAnswer: q.correctAnswer,
                        isCorrect: userAnswer === q.correctAnswer
                    };
                });

                const payload = {
                    userId: liffUserId,
                    quizScore: currentScore,
                    surveyData: surveyAnswers,
                    quizResults: quizResults
                };
                
                console.log("Submitting to:", GAS_WEB_APP_URL);
                console.log("Payload:", payload);

                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8', 
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP Error: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                console.log("GAS Response:", result);

                if (result.result !== 'success') {
                    throw new Error(result.message || 'Script Error occurred');
                }
                
                closeModal();
                showFinalResultsPage();

            } catch (error) {
                console.error("Submission Failed:", error);
                
                let errorMessage = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
                if (error.message.includes("Failed to fetch") || error.message.includes("NetworkError")) {
                    errorMessage = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ã§ã™ã€‚<br>URLãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚<br>ï¼ˆCORSã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ã‚ã‚Šï¼‰";
                } else if (error.message.includes("HTTP Error")) {
                    errorMessage = `ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ${error.message}<br>GASã®ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
                } else {
                    errorMessage = `ã‚¨ãƒ©ãƒ¼è©³ç´°:<br>${error.message}`;
                }

                renderModal(`
                    <div style="background:white; border-radius:1.5rem; padding:2rem; text-align:center;">
                        <h2 class="text-xl font-bold text-red-600 mb-2">é€ä¿¡å¤±æ•—</h2>
                        <p class="text-slate-600 font-bold mb-4 text-sm">
                            ${errorMessage}
                        </p>
                        <p class="text-xs text-slate-400 mb-4 bg-slate-100 p-2 rounded text-left overflow-auto max-h-24">
                            URL: ${GAS_WEB_APP_URL}<br>
                            Err: ${error.toString()}
                        </p>
                        <button id="show-results-anyway-button" class="action-button">çµæœã ã‘è¦‹ã‚‹</button>
                    </div>
                `, false);

                 const btn = document.getElementById('show-results-anyway-button');
                 if(btn) {
                     btn.addEventListener('click', () => {
                        playSound('click');
                        closeModal();
                        setTimeout(showFinalResultsPage, 300);
                     });
                 }
            }
        }

        // --- SURVEY LOGIC ---
        function startSurvey() {
            closeModal();
            setTimeout(() => {
                const progressBarContainer = document.querySelector('.progress-bar-container');
                if(progressBarContainer) progressBarContainer.style.display = 'none';

                cardContainer.classList.remove('relative');
                cardContainer.style.minHeight = 'auto';
                cardContainer.innerHTML = `<div class="survey-shell">
                    <div id="survey-content-area" class="survey-content-area"></div>
                </div>`;
                renderSurveyScreen(0, true);
            }, 300);
        }

        function renderSurveyScreen(index, isInitial = false) {
            const screenData = surveyData[index];
            if (!screenData) return;
            const contentHTML = buildSurveyScreenHTML(screenData);
            const surveyContentArea = document.getElementById('survey-content-area');
            if(!surveyContentArea) return;
            
            const currentContentEl = surveyContentArea.querySelector('.survey-screen-content');
            if (currentContentEl && !isInitial) {
                currentContentEl.classList.add('content-out');
                
                setTimeout(() => {
                    surveyContentArea.innerHTML = contentHTML;
                    const newContentEl = surveyContentArea.querySelector('.survey-screen-content');
                    newContentEl.classList.add('content-in');
                    attachSurveyNavListeners();
                }, 300);
            } else {
                surveyContentArea.innerHTML = contentHTML;
                const newContentEl = surveyContentArea.querySelector('.survey-screen-content');
                if(newContentEl) newContentEl.classList.add('content-in');
                attachSurveyNavListeners();
            }
        }
        
        function buildSurveyScreenHTML(screenData) {
            let optionsHTML = '';
            const isQuestion = ['radio', 'likert', 'consent'].includes(screenData.type);
            const savedAnswer = surveyAnswers[screenData.id];
            
            const questionScreens = surveyData.filter(s => ['radio', 'likert', 'consent'].includes(s.type));
            const currentScreenNum = questionScreens.findIndex(s => s.id === screenData.id) + 1;


            if (screenData.type === 'radio' || screenData.type === 'consent') {
                optionsHTML = `<div class="grid ${screenData.layout || 'grid-cols-1'} gap-4 mt-4">${screenData.options.map((opt, i) => {
                    const optionClass = opt.style === 'decline' ? 'survey-option-decline' : '';
                    return `<div style="animation-delay: ${i * 70 + 150}ms"><input type="radio" name="${screenData.id}" value="${opt.t}" class="survey-option-input hidden" id="opt-${screenData.id}-${i}" ${savedAnswer === opt.t ? 'checked' : ''}><label for="opt-${screenData.id}-${i}" class="survey-option-label ${optionClass}">${opt.i ? `<span class="icon">${opt.i}</span>` : ''}<span>${opt.t}</span></label></div>`
                }).join('')}</div>`;
            } else if (screenData.type === 'likert') {
                const faces = ['ğŸ˜¥', 'ğŸ˜Ÿ', 'ğŸ˜', 'ğŸ™‚', 'ğŸ˜„'];
                const leftAnnotationLabel = screenData.options.find(o => o.v === 1).l;
                const rightAnnotationLabel = screenData.options.find(o => o.v === 5).l;
                const middleAnnotationLabel = screenData.options.find(o => o.v === 3).l;

                optionsHTML = `
                    <div class="likert-horizontal-container">
                        <div class="likert-emoji-bar">
                            ${[1, 2, 3, 4, 5].map((v) => `
                                <div>
                                    <input type="radio" name="${screenData.id}" value="${v}" class="likert-emoji-input hidden" id="opt-${screenData.id}-${v}" ${savedAnswer == v ? 'checked' : ''}>
                                    <label for="opt-${screenData.id}-${v}" class="likert-emoji-label">${faces[v-1]}</label>
                                </div>
                            `).join('')}
                        </div>
                        <div class="likert-annotation-bar">
                            <span>${leftAnnotationLabel}</span>
                            <span>${middleAnnotationLabel}</span>
                            <span>${rightAnnotationLabel}</span>
                        </div>
                    </div>`;
            }

            let navigationHTML = '';
            if (screenData.type === 'completion') {
                navigationHTML = `
                    <div class="mt-6 flex flex-col items-center gap-4">
                        <button id="survey-complete-button" class="survey-nav-button w-full max-w-xs">${screenData.buttonText}</button>
                        <button id="survey-back-button" class="survey-nav-button survey-back-button w-1/2">æˆ»ã‚‹</button>
                    </div>
                `;
            } else if (screenData.type === 'section_header') {
                 navigationHTML = `<div class="h-16 mt-6"></div>`;
            } else if (currentSurveyScreen > 0) {
                 navigationHTML = `<div class="flex justify-center mt-6"><button id="survey-back-button" class="survey-nav-button survey-back-button w-1/2">æˆ»ã‚‹</button></div>`;
            } else {
                 navigationHTML = `<div class="h-16 mt-6"></div>`;
            }
            
            const progress = (currentScreenNum > 0 ? (currentScreenNum / totalScreens) * 100 : 0);

            return `
                <div class="survey-screen-content">
                    <div class="mb-4">
                        ${isQuestion ? `<p class="text-right text-sm font-bold text-indigo-400 mb-1">ã—ã¤ã‚‚ã‚“ ${currentScreenNum} / ${totalScreens}</p>`: '<p class="text-right text-sm font-bold text-transparent mb-1">_</p>'}
                        <div class="survey-progress-bar-container"><div style="width: ${progress}%" class="survey-progress-bar"></div></div>
                    </div>
                    <div class="flex-grow flex flex-col justify-center text-center">
                        <h2 class="text-2xl font-extrabold text-slate-800 mb-2">${screenData.title || screenData.question}</h2>
                        ${(screenData.type === 'consent' && screenData.question) ? `<p class="text-sm text-slate-600 text-left">${screenData.question}</p>` : ''}
                        ${optionsHTML}
                    </div>
                    <div class="mt-4">${navigationHTML}</div>
                </div>`;
        }
        
        function attachSurveyNavListeners() {
            const backBtn = document.getElementById('survey-back-button');
            const completeBtn = document.getElementById('survey-complete-button');

            const screenData = surveyData[currentSurveyScreen];
            if (!screenData) return;
            const isQuestion = ['radio', 'likert', 'consent'].includes(screenData.type);
            
            if(isQuestion) {
                 document.querySelectorAll(`.survey-option-label, .likert-emoji-label`).forEach(label => {
                      label.addEventListener('click', () => {
                          const inputId = label.getAttribute('for');
                          const input = document.getElementById(inputId);
                          if (!input || input.disabled) return;

                          const allInputsInGroup = document.querySelectorAll(`input[name="${input.name}"]`);
                          allInputsInGroup.forEach(i => i.disabled = true);
                          
                          input.checked = true;

                          playSound('click');
                          setTimeout(() => {
                              allInputsInGroup.forEach(i => i.disabled = false);
                              handleSurveyNav('next');
                          }, 250);
                      });
                 });
            } else if (screenData.type === 'section_header') {
                setTimeout(() => handleSurveyNav('next'), 800);
            }

            if(backBtn) backBtn.addEventListener('click', () => { playSound('click'); handleSurveyNav('back'); });
            if(completeBtn) completeBtn.addEventListener('click', () => { 
                playSound('click'); 
                // Instead of calling submit directly, check if we need login
                handleLogin();
            });
        }
        
        function handleSurveyNav(direction) {
            const surveyContentArea = document.getElementById('survey-content-area');
            if (!surveyContentArea) return;
            surveyContentArea.dataset.direction = direction;

            if (direction === 'next') {
                const screenData = surveyData[currentSurveyScreen];
                if (screenData) {
                    const isQuestion = ['radio', 'likert', 'consent'].includes(screenData.type);
                    if (isQuestion) {
                        const selected = document.querySelector(`input[name="${screenData.id}"]:checked`);
                        if (selected) {
                            surveyAnswers[screenData.id] = selected.value;
                        }
                    }
                }

                if (currentSurveyScreen < surveyData.length - 1) {
                    currentSurveyScreen++;
                    while(surveyData[currentSurveyScreen].type === 'section_header' && direction === 'back') {
                        currentSurveyScreen--;
                    }
                    renderSurveyScreen(currentSurveyScreen);
                } else {
                    console.warn("Tried to navigate past the end of the survey.");
                }

            } else { // back
                if (currentSurveyScreen > 0) {
                    currentSurveyScreen--;
                     while(surveyData[currentSurveyScreen].type === 'section_header') {
                        if (currentSurveyScreen > 0) {
                            currentSurveyScreen--;
                        } else {
                            break;
                        }
                    }
                    renderSurveyScreen(currentSurveyScreen);
                } else {
                    console.warn("Tried to navigate before the start of the survey.");
                }
            }
        }
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize LIFF immediately on load
            await initializeLiff();

            if (sessionStorage.getItem('isLiffLoginRedirect') === 'true') {
                sessionStorage.removeItem('isLiffLoginRedirect');
                const savedState = JSON.parse(sessionStorage.getItem('appState'));
                if (savedState) {
                    currentScore = savedState.currentScore;
                    userSelections = savedState.userSelections;
                    surveyAnswers = savedState.surveyAnswers;
                    sessionStorage.removeItem('appState');
                    submitSurveyDataToGAS();
                    return;
                }
            }
            
             updateProgress();
             renderCard(0);
        });
    </script>
</body>
</html>
